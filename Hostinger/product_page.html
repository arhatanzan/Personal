<style>
  /* Theme variables — change these to update site colors quickly */
  :root {
    --page-bg: #f8f6f2;
    --card-bg: #ffffff;
    --white: #ffffff;
    --accent: #d4a017;
    --navy: #0a2342;
    --navy-rgb: 10,34,66; /* use with rgba(var(--navy-rgb),a) */
    --muted: #5a6673;
    --paid-bg: #7a2e2e;
    --label-free-bg: var(--navy);
    --label-free-text: var(--page-bg);
    --label-paid-bg: var(--paid-bg);
    --label-paid-text: var(--page-bg);
    --border: rgba(0,0,0,0.06);
    --radius: 10px;
    --gap: 18px;
    --container: 1200px;
    --thumb-grad-1: #ececec;
  }

  * { box-sizing: border-box; }
  body, html { margin:0; padding:0; font-family: Calibri, Arial, sans-serif; background: var(--page-bg); color: var(--navy); }
  .prod-wrap { max-width: var(--container); margin: 28px auto; padding: 20px; }
  /* Stack header vertically and left-align contents for a precise layout */
  .prod-header { display:flex; flex-direction:column; gap:12px; align-items:flex-start; margin-bottom:12px; }
  .prod-title h1 { margin:0; font-size:32px; line-height:1.05; color:var(--navy); font-weight:700; letter-spacing:-0.2px; }
  .prod-sub { color:var(--muted); font-size:14px; margin:0; }
  /* Stack search above filters; keep controls right-aligned */
  .prod-controls { display:flex; flex-direction:column; gap:8px; align-items:flex-end; width:100%; }

  /* Controls */
  /* Search sits on its own row and is left-most */
  .search { display:flex; align-items:center; gap:8px; background:var(--white); border-radius:8px; padding:8px 10px; flex:0 0 auto; max-width:480px; min-width:200px; }
  .search input { border:0; outline:0; width:100%; font-size:14px; color:var(--navy); background:transparent; }

  /* Grouped row for filters + reset button (placed under search) */
  .controls-row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; width:auto; margin-top:0; justify-content:flex-end; }
  .select, .btn { background:var(--white); border-radius:8px; padding:8px 12px; font-size:14px; border:1px solid var(--border); }
  .btn { cursor:pointer; }
  .btn.primary { background:var(--accent); color:var(--navy); font-weight:600; }

  /* Make reset button stand out: navy background, white text, and add tactile click effect */
  #resetBtn { background: var(--navy); color: var(--white); border:1px solid var(--navy); font-weight:600; transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease; box-shadow: 0 6px 12px rgba(10,34,66,0.08); }
  #resetBtn:hover { opacity:0.95; }
  #resetBtn:active { transform: translateY(1px) scale(0.996); box-shadow: 0 3px 8px rgba(10,34,66,0.06); }

  /* Grid & Cards */
  .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:var(--gap); margin-top:18px; }
  .card { background:var(--card-bg); border-radius:var(--radius); padding:16px; border:4px solid var(--accent); display:flex; flex-direction:column; gap:12px; min-height:240px; overflow:hidden; }
  .thumb { height:110px; border-radius:6px; background:linear-gradient(180deg,var(--thumb-grad-1),var(--white)); display:flex; align-items:center; justify-content:center; font-weight:700; color:var(--muted); position:relative; overflow:hidden; }
  .thumb img { width:100%; height:100%; object-fit:cover; display:block; border-radius:6px; }
  .title { font-size:16px; font-weight:700; margin:0; color:var(--navy); }
  .title a { color:inherit; text-decoration:none; }
  .desc { font-size:14px; color:var(--muted); margin:0; line-height:1.4; }
  .tags { display:flex; gap:8px; flex-wrap:wrap; margin-top:4px; }
  .tag { border:1px solid rgba(0,0,0,0.1); padding:3px 8px; border-radius:999px; font-size:12px; }
  .label-free { background:var(--label-free-bg); color:var(--label-free-text); border-radius:999px; padding:3px 8px; font-size:12px; }
  .label-paid { background:var(--label-paid-bg); color:var(--label-paid-text); border-radius:999px; padding:3px 8px; font-size:12px; }
  .card-footer { margin-top:auto; display:flex; align-items:center; gap:8px; }
  .card-footer .primary-wrap { flex:1 1 auto; }
  .card-footer .actions { flex:0 0 auto; display:flex; gap:8px; align-items:center; }
  .card-footer .actions { margin-left: auto; }
  .download-btn { background:var(--accent); color:var(--navy); border-radius:8px; padding:8px 12px; text-decoration:none; font-weight:700; font-size:14px; display:inline-flex; align-items:center; justify-content:center; }
  /* unify action buttons (Details / Back) so they're visually identical and align perfectly */
  .details-btn, .back-btn { background:transparent; border:1px solid rgba(0,0,0,0.1); border-radius:8px; padding:6px 12px; font-size:14px; cursor:pointer; color:var(--navy); display:inline-flex; align-items:center; justify-content:center; min-width:86px; box-sizing:border-box; }
  .empty { text-align:center; color:var(--muted); padding:40px 0; }

  /* SEO helper button (sitemap) */
  #sitemapBtn { background:var(--white); border-radius:8px; border:1px solid var(--border); padding:8px 10px; cursor:pointer; }

  /* Go To Top Button */
  #goTopBtn { position:fixed; bottom:24px; right:24px; background:var(--accent); color:var(--navy); border:none; padding:12px 16px; font-size:14px; font-weight:700; border-radius:10px; cursor:pointer; box-shadow:0 4px 10px rgba(0,0,0,0.15); opacity:0; pointer-events:none; transition:opacity .25s ease; z-index:9999; }
  #goTopBtn.show { opacity:1; pointer-events:all; }

  /* Pagination */
  .pagination-wrap { display:flex; justify-content:center; align-items:center; gap:8px; margin-top:18px; flex-wrap:wrap; }
  .page-btn { background:var(--white); border:1px solid var(--border); border-radius:6px; padding:6px 10px; cursor:pointer; }
  .page-btn.active { background:var(--navy); color:var(--white); border-color:var(--navy); }
  .go-page { display:flex; gap:6px; align-items:center; margin-left:8px; }
  .go-page input { width:64px; padding:6px 8px; border-radius:6px; border:1px solid var(--border); }

  /* Toast */
  #toast { position:fixed; left:50%; transform:translateX(-50%); bottom:36px; background:rgba(var(--navy-rgb),0.95); color:var(--white); padding:10px 14px; border-radius:8px; font-weight:600; box-shadow:0 6px 18px rgba(var(--navy-rgb),0.25); opacity:0; pointer-events:none; transition:opacity .25s ease, transform .25s ease; z-index:10000; }
  #toast.show { opacity:1; pointer-events:all; transform:translateX(-50%) translateY(0); }

  /* Modal */
  /* Card flip: use grid-based overlap (avoids absolute/fixed positioning) */
  .card { background:var(--card-bg); border-radius:var(--radius); padding:0; border:4px solid var(--accent); display:flex; flex-direction:column; gap:0; min-height:240px; overflow:hidden; perspective:1000px; }
  .card-inner { transition: transform .5s ease; transform-style: preserve-3d; display:grid; width:100%; height:100%; }
  .card-front, .card-back { grid-area: 1/1; display:flex; flex-direction:column; gap:12px; padding:16px; box-sizing:border-box; backface-visibility: hidden; -webkit-backface-visibility: hidden; }
  .card-front { background:transparent; }
  .card-back { background:var(--card-bg); color:var(--navy); transform: rotateY(180deg); border-radius: calc(var(--radius) - 2px); align-items:flex-start; }
  /* Ensure the footer on the back face stretches full width so actions can be pushed right */
  .card-back .card-footer { width: 100%; }
  .card.is-flipped .card-inner { transform: rotateY(180deg); }
  /* Ensure long content on back side scrolls within the card without moving layout */
  .card-back { overflow:auto; }

  /* Price display */
  .price-row { display:flex; gap:8px; align-items:center; margin-top:8px; }
  .price-old { text-decoration:line-through; color:var(--muted); font-size:13px; }
  .price-now { font-weight:800; color:var(--navy); font-size:15px; }
  .discount-badge { background:var(--accent); color:var(--navy); border-radius:8px; padding:4px 6px; font-size:12px; font-weight:700; }

  @media (max-width:1000px) { .search { max-width:420px; } .prod-title h1 { font-size:28px; } }
  @media (max-width:600px) { 
    .search { max-width:100%; flex:1 1 100%; min-width:0; }
    .controls-row { width:100%; justify-content:flex-start; margin-top:6px; }
    .search input { width:130px; }
    .prod-title h1 { font-size:22px; }
    .card { min-height:200px; }
    .card-back { max-height: none; }
  }
</style>

<div class="prod-wrap" aria-live="polite">
  <div class="prod-header">
    <div class="prod-title">
      <h1 id="pageH1">Digital & Physical Products</h1>
      <div id="pageDesc" class="prod-sub">Instant downloads + external store products</div>
    </div>

    <div class="prod-controls" id="controls">
      <div class="search">
        <input id="searchInput" placeholder="Search products…" aria-label="Search products" />
      </div>

      <div class="controls-row">
        <select id="categorySelect" class="select" aria-label="Filter by category">
          <option value="">All categories</option>
        </select>

        <select id="priceSelect" class="select" aria-label="Filter by price">
          <option value="">All prices</option>
        </select>

        <select id="pageSizeSelect" class="select" title="Items per page" aria-label="Items per page">
          <option value="all">All (default)</option>
          <option value="10">10 / page</option>
          <option value="30">30 / page</option>
          <option value="50">50 / page</option>
          <option value="100">100 / page</option>
        </select>

        <select id="sortSelect" class="select" aria-label="Sort products">
          <option value="new">Newest</option>
          <option value="az">A → Z</option>
          <option value="za">Z → A</option>
        </select>

        <button id="resetBtn" class="btn" aria-label="Reset filters">Reset</button>
        </div>
    </div>
  </div>

  <div id="grid" class="grid"></div>
  <div id="empty" class="empty" style="display:none">No products found.</div>

  <div id="pagination" class="pagination-wrap" style="display:none"></div>
</div>

<button id="goTopBtn" aria-label="Go to top">↑ Top</button>
<div id="toast" role="status" aria-live="polite"></div>

<script>
(function(){
  'use strict';
const SITE_BASE = (window.SITE_BASE_URL && window.SITE_BASE_URL.replace(/\/$/, "")) || location.origin.replace(/\/$/, "");
const LISTING_PATH = '/products'; // relative path for listing pages in sitemap/canonical (change if needed)

/*
  THEME HELPER
  If you want to change colors at runtime without editing the CSS, call
    setTheme({ '--accent': '#ff6600', '--navy': '#002244' });
  It updates CSS custom properties on :root and keeps the file self-contained.
*/
function setTheme(vars){
  if(!vars || typeof vars !== 'object') return;
  const root = document.documentElement;
  Object.keys(vars).forEach(k => {
    try{ root.style.setProperty(k, vars[k]); }catch(e){}
  });
}

/* PRODUCT DATA - edit entries below as needed */
const PRODUCTS = [
  {
    id: "p1",
    buttonLabel: "",
    category: "Guides",
    description: "A practical workbook for crafting narratives using data.",
    discountPercent: null,
    fileName: "data-storytelling-workbook.pdf",
    imageUrl: "",
    originalPrice: "",
    priceCurrency: "",
    productUrl: "/product/data-storytelling-workbook",
    seoUrl: "/product/data-storytelling-workbook",
    thumbText: "Workbook",
    title: "Data Storytelling Workbook",
    type: "download"
  },
  {
    id: "p2",
    buttonLabel: "",
    category: "Cheatsheets",
    description: "Quick access reference for creating effective monitors.",
    discountPercent: null,
    fileName: "datadog-monitors-cheatsheet.pdf",
    imageUrl: "",
    originalPrice: "",
    priceCurrency: "",
    productUrl: "/product/datadog-monitors-cheatsheet",
    seoUrl: "/product/datadog-monitors-cheatsheet",
    thumbText: "Cheatsheet",
    title: "Datadog Monitors Cheat Sheet",
    type: "download"
  },
  {
    id: "p3",
    buttonLabel: "Buy on Amazon",
    category: "Books",
    description: "A hardcover book available on Amazon.",
    discountPercent: null,
    fileName: "",
    imageUrl: "",
    originalPrice: "",
    priceCurrency: "INR",
    productUrl: "https://amazon.in/your-product",
    seoUrl: "/product/modern-leadership",
    thumbText: "Hardcover",
    title: "Modern Leadership (Hardcover)",
    type: "external"
  },
  {
    id: "p4",
    buttonLabel: "",
    category: "Slides",
    description: "Download slide deck on digital democracy & media.",
    discountPercent: null,
    fileName: "digital-democracy-slides.zip",
    imageUrl: "",
    originalPrice: "",
    priceCurrency: "",
    productUrl: "/product/digital-democracy-slides",
    seoUrl: "/product/digital-democracy-slides",
    thumbText: "Slides",
    title: "Digital Democracy Course (Slides)",
    type: "download"
  },
  {
    id: "p5",
    buttonLabel: "Get Template",
    category: "Templates",
    description: "A premium digital template on Gumroad.",
    discountPercent: null,
    fileName: "",
    imageUrl: "",
    originalPrice: "",
    priceCurrency: "INR",
    productUrl: "https://gumroad.com/your-product",
    seoUrl: "/product/aesthetic-portfolio-template",
    thumbText: "Template",
    title: "Aesthetic Portfolio Template",
    type: "external"
  }
];

/* DOM refs (cached) */
const refs = {
  grid: document.getElementById('grid'),
  empty: document.getElementById('empty'),
  paginationWrap: document.getElementById('pagination'),
  categorySelect: document.getElementById('categorySelect'),
  priceSelect: document.getElementById('priceSelect'),
  pageSizeSelect: document.getElementById('pageSizeSelect'),
  searchInput: document.getElementById('searchInput'),
  sortSelect: document.getElementById('sortSelect'),
  resetBtn: document.getElementById('resetBtn'),
  goTopBtn: document.getElementById('goTopBtn'),
  toastEl: document.getElementById('toast'),
  pageH1: document.getElementById('pageH1'),
  pageDescEl: document.getElementById('pageDesc')
  
};

// Modal removed — using card flip interaction instead.

// Note: use `refs.*` for DOM access throughout the file.

let filteredProducts = []; // unpaged
let currentPage = 1;
let currentPageSize = 'all';
let toastTimer = null;

/* Helpers */
function escapeHtml(s){ return (s||"").toString().replace(/&/g,'&amp;').replace(/</g,'&lt;'); }
function cap(s){ return (s||'').charAt(0).toUpperCase() + (s||'').slice(1); }

/* SEO elements: dynamic title/meta/og/twitter and JSON-LD injection */
function ensureMetaTag(nameOrProp, value, isProperty=false){
  // nameOrProp: meta name or property (og:)
  let selector = isProperty ? `meta[property="${nameOrProp}"]` : `meta[name="${nameOrProp}"]`;
  let m = document.head.querySelector(selector);
  if(!m){
    m = document.createElement('meta');
    if(isProperty) m.setAttribute('property', nameOrProp);
    else m.setAttribute('name', nameOrProp);
    document.head.appendChild(m);
  }
  m.setAttribute('content', value || '');
}

function ensureLinkRel(rel, href){
  let el = document.head.querySelector(`link[rel="${rel}"]`);
  if(!el){
    el = document.createElement('link');
    el.setAttribute('rel', rel);
    document.head.appendChild(el);
  }
  el.setAttribute('href', href || '');
}

function updateTitleAndMeta(){
  // Create a context-aware title & description (dynamic)
  const parts = [];
  const cat = refs.categorySelect.value;
  const price = refs.priceSelect.value;
  const q = refs.searchInput.value.trim();

  if(q) parts.push(`${q} —`);
  if(cat) parts.push(`${cap(cat)}`);
  if(price) parts.push(`${cap(price)}`);
  parts.push('Digital & Physical Products');
  const title = parts.join(' | ');
  document.title = title;

  const descParts = [];
  if(cat) descParts.push(`${cap(cat)} products`);
  if(price) descParts.push(`${cap(price)} items`);
  if(q) descParts.push(`Search results for "${q}"`);
  descParts.push('Instant downloads, external store links, and templates.');
  const description = descParts.join(' • ');

  // ensure meta tags
  ensureMetaTag('description', description);
  ensureMetaTag('robots', 'index,follow');
  ensureMetaTag('twitter:card', 'summary_large_image');
  ensureMetaTag('twitter:title', title);
  ensureMetaTag('twitter:description', description);
  ensureMetaTag('og:title', title, true);
  ensureMetaTag('og:description', description, true);
  ensureMetaTag('og:type', 'website', true);
  ensureMetaTag('og:site_name', document.location.hostname || SITE_BASE, true);
  // fallback OG image - set if you have an asset
  ensureMetaTag('og:image', `${SITE_BASE}/assets/og-products.jpg`, true);
  ensureMetaTag('twitter:image', `${SITE_BASE}/assets/og-products.jpg`);
}

/* Update canonical + prev/next links dynamically */
function updateCanonicalAndPaginationLinks(pageNum, totalPages, pageSize){
  // Build canonical URL for listing (with page & size query params)
  const urlBase = SITE_BASE + (LISTING_PATH.startsWith('/') ? LISTING_PATH : '/' + LISTING_PATH);
  const params = new URLSearchParams();
  if(pageNum && pageNum > 1) params.set('page', pageNum);
  if(pageSize && pageSize !== 'all') params.set('pageSize', pageSize);
  const canonicalHref = params.toString() ? `${urlBase}?${params.toString()}` : urlBase;

  ensureLinkRel('canonical', canonicalHref);

  // prev / next
  // remove prev/next if first or last
  if(pageNum > 1){
    const prevParams = new URLSearchParams();
    const prevPage = pageNum - 1;
    if(prevPage > 1) prevParams.set('page', prevPage);
    if(pageSize && pageSize !== 'all') prevParams.set('pageSize', pageSize);
    ensureLinkRel('prev', prevParams.toString() ? `${urlBase}?${prevParams.toString()}` : urlBase);
  } else {
    // remove prev if present
    const prevEl = document.head.querySelector('link[rel="prev"]');
    if(prevEl) prevEl.remove();
  }

  if(pageNum < totalPages){
    const nextParams = new URLSearchParams();
    const nextPage = pageNum + 1;
    if(nextPage > 1) nextParams.set('page', nextPage);
    if(pageSize && pageSize !== 'all') nextParams.set('pageSize', pageSize);
    ensureLinkRel('next', nextParams.toString() ? `${urlBase}?${nextParams.toString()}` : urlBase);
  } else {
    const nextEl = document.head.querySelector('link[rel="next"]');
    if(nextEl) nextEl.remove();
  }
}

/* JSON-LD injection (builds product Offers when price data provided) */
function injectStructuredData(){
  const items = PRODUCTS.map(p => {
    const node = {
      "@type": "Product",
      "name": p.title,
      "description": p.description
    };

    // Prefer SEO-friendly URL for canonical product page in structured data
    const urlSource = p.seoUrl || p.productUrl;
    if(urlSource){
      node.url = urlSource.startsWith('http') ? urlSource : SITE_BASE + (urlSource.startsWith('/') ? urlSource : '/' + urlSource);
    }
    if(p.imageUrl) node.image = p.imageUrl.startsWith('http') ? p.imageUrl : SITE_BASE + (p.imageUrl.startsWith('/') ? p.imageUrl : '/' + p.imageUrl);

    // Compute price and offers using only originalPrice + discountPercent
    function toNumber(s){ if(s === undefined || s === null || s === '') return NaN; const n = Number(String(s).replace(/,/g,'')); return isNaN(n) ? NaN : n; }
    const origNum = toNumber(p.originalPrice);
    const disc = (typeof p.discountPercent === 'number') ? p.discountPercent : (p.discountPercent ? Number(p.discountPercent) : NaN);

    if(!isNaN(origNum)){
      const curr = p.priceCurrency || 'INR';
      if(!isNaN(disc)){
        const safeDisc = Math.max(0, Math.min(100, disc));
        const priceNowNum = +(origNum * (1 - safeDisc / 100)).toFixed(2);
        node.offers = {
          "@type": "Offer",
          "price": priceNowNum.toFixed(2),
          "priceCurrency": (p.priceCurrency || "INR"),
          "availability": "https://schema.org/InStock"
        };
        node.priceSpecification = {
          "@type": "PriceSpecification",
          "priceCurrency": (p.priceCurrency || "INR"),
          "price": origNum.toFixed(2)
        };
      } else {
        node.offers = {
          "@type": "Offer",
          "price": origNum.toFixed(2),
          "priceCurrency": (p.priceCurrency || "INR"),
          "availability": "https://schema.org/InStock"
        };
        node.priceSpecification = {
          "@type": "PriceSpecification",
          "priceCurrency": (p.priceCurrency || "INR"),
          "price": origNum.toFixed(2)
        };
      }
    } else {
      // No reliable numeric price — include an Offer without a price (keeps item discoverable)
      node.offers = { "@type": "Offer", "availability": "https://schema.org/InStock" };
    }

    return node;
  });

  const graph = { "@context": "https://schema.org", "@graph": items };
  let existing = document.getElementById('__products_jsonld');
  if(existing) existing.textContent = JSON.stringify(graph);
  else {
    const s = document.createElement('script');
    s.type = 'application/ld+json';
    s.id = '__products_jsonld';
    s.textContent = JSON.stringify(graph);
    document.head.appendChild(s);
  }
}

/* Rendering, filters and pagination (updates SEO hooks after render) */
function getFileType(prod){ if(prod.type === "external") return "LINK"; if(prod.fileName) return prod.fileName.split('.').pop().toUpperCase(); return "FILE"; }
function createDemoFileBlob(p){ const txt = `${p.title}\n---\n${p.description}\nGenerated: ${new Date().toLocaleString()}`; return new Blob([txt], {type:'text/plain'}); }
function renderPrimaryButton(prod){
  if(prod.type === "download"){
    return `<a class="download-btn" data-id="${prod.id}" href="#" aria-label="Download ${escapeHtml(prod.title)}">Download</a>`;
  }
  if(prod.type === "external"){
    const label = prod.buttonLabel || "Buy Now";
    const href = prod.productUrl || '#';
    return `<a class="download-btn" href="${escapeHtml(href)}" target="_blank" rel="noopener" aria-label="${escapeHtml(label)}">${escapeHtml(label)}</a>`;
  }
  return '';
}
// Return a short text label (FREE / PAID) based solely on originalPrice + discountPercent
function getPriceLabelText(prod){
  function toNumber(s){ if(s === undefined || s === null || s === '') return NaN; const n = Number(String(s).replace(/,/g,'')); return isNaN(n) ? NaN : n; }
  const orig = toNumber(prod.originalPrice);
  const disc = (typeof prod.discountPercent === 'number') ? prod.discountPercent : (prod.discountPercent ? Number(prod.discountPercent) : NaN);

  if(!isNaN(orig)){
    if(!isNaN(disc)){
      const safeDisc = Math.max(0, Math.min(100, disc));
      const priceNow = +(orig * (1 - safeDisc / 100)).toFixed(2);
      if(priceNow === 0 || safeDisc === 100) return 'FREE';
      return 'PAID';
    }
    return orig === 0 ? 'FREE' : 'PAID';
  }

  // Unknown/not provided
  return '';
}

// Render HTML badge based on inferred price label or explicit token
function renderPriceLabel(prod){
  const txt = getPriceLabelText(prod);
  if(txt === 'FREE') return `<span class="label-free">FREE</span>`;
  if(txt === 'PAID') return `<span class="label-paid">PAID</span>`;
  if(txt) return `<span class="tag">${escapeHtml(txt)}</span>`;
  return '';
}

/* Format number as INR currency string (₹ with grouping) */
function formatCurrency(v, currency){
  const curr = (currency && String(currency).trim()) || 'INR';
  const n = Number(String(v).replace(/,/g,''));
  if(isNaN(n)){
    try{
      // show zero in requested currency
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: curr, minimumFractionDigits:2, maximumFractionDigits:2 }).format(0);
    }catch(e){
      return curr === 'INR' ? '₹0.00' : `${curr}0.00`;
    }
  }
  try{
    // Use a locale that commonly maps to the currency for nicer formatting
    const locale = curr === 'INR' ? 'en-IN' : (curr === 'USD' ? 'en-US' : 'en-US');
    return new Intl.NumberFormat(locale, { style: 'currency', currency: curr, minimumFractionDigits:2, maximumFractionDigits:2 }).format(n);
  }catch(e){
    // fallback
    if(curr === 'INR') return '₹' + n.toFixed(2);
    return curr + ' ' + n.toFixed(2);
  }
}

/* renderPriceBlock(p) */
function renderPriceBlock(p){
  // Helper to parse price string to number safely
  function toNumber(s){
    if(s === undefined || s === null || s === '') return NaN;
    // Remove commas if any, then parse
    const n = Number(String(s).replace(/,/g,''));
    return isNaN(n) ? NaN : n;
  }

  // If product has explicit discountPercent + originalPrice
  const origNum = toNumber(p.originalPrice);
    const disc = (typeof p.discountPercent === 'number') ? p.discountPercent : (p.discountPercent ? Number(p.discountPercent) : NaN); 
    const curr = p.priceCurrency || 'INR';
  // Case: discount provided and original price valid
  if(!isNaN(origNum) && !isNaN(disc)){
    // clamp discount between 0 and 100
    const safeDisc = Math.max(0, Math.min(100, disc));
    const priceNowNum = +(origNum * (1 - safeDisc / 100)).toFixed(2);
    // For 100% off show FREE
    if(safeDisc === 100){
        const origHtml = `<span class="price-old">${escapeHtml(formatCurrency(origNum, curr))}</span>`;
      return `<div class="price-row">${origHtml}<span class="price-now">FREE</span><span class="discount-badge">${safeDisc}% OFF</span></div>`;
    }
    // Normal discounted price
      const origHtml = `<span class="price-old">${escapeHtml(formatCurrency(origNum, curr))}</span>`;
      const nowHtml = `<span class="price-now">${escapeHtml(formatCurrency(priceNowNum, curr))}</span>`;
    return `<div class="price-row">${origHtml}${nowHtml}<span class="discount-badge">${safeDisc}% OFF</span></div>`;
  }

  // If originalPrice present but no discount specified, treat originalPrice as current price
  if(!isNaN(origNum) && (isNaN(disc) || disc === 0)){
      return `<div class="price-row"><span class="price-now">${escapeHtml(formatCurrency(origNum, curr))}</span></div>`;
  }

  // No reliable pricing info (originalPrice not provided) — render nothing
  return '';
}
function renderProductsPage(list, page, pageSize){
  refs.grid.innerHTML = '';

  if(!list.length){
    refs.empty.style.display = 'block';
    refs.paginationWrap.style.display = 'none';
    updateTitleAndMeta();
    injectStructuredData();
    updateCanonicalAndPaginationLinks(1,1,'all');
    return;
  }
  refs.empty.style.display = 'none';

  let pageNum = parseInt(page,10) || 1;
  let size = pageSize === 'all' ? list.length : parseInt(pageSize,10);
  const totalItems = list.length;
  const totalPages = size === 0 ? 1 : Math.max(1, Math.ceil(totalItems/size));
  if(pageNum > totalPages) pageNum = totalPages;
  const start = pageSize === 'all' ? 0 : (pageNum - 1) * size;
  const end = pageSize === 'all' ? totalItems : Math.min(totalItems, start + size);
  const slice = list.slice(start, end);

  slice.forEach(p => {
    const card = document.createElement('div'); card.className = 'card';

    // image fallback: prefer imageUrl; fallback to thumbText
    let thumbHtml = `<div class="thumb" aria-hidden="true">${escapeHtml(p.thumbText)}</div>`;
    if(p.imageUrl){
      const imgSrc = escapeHtml(p.imageUrl);
      thumbHtml = `<div class="thumb" data-thumb-text="${escapeHtml(p.thumbText)}"><img src="${imgSrc}" alt="${escapeHtml(p.title)} thumbnail" loading="lazy" onerror="this.dataset.failed='1'; this.style.display='none'; this.parentNode.classList.add('thumb-failed');"></div>`;
    }

    const titleHref = p.seoUrl || p.productUrl || '';
    const titleLink = titleHref ? `<a href="${escapeHtml(titleHref)}">${escapeHtml(p.title)}</a>` : `<span>${escapeHtml(p.title)}</span>`;

    const priceLabel = getPriceLabelText(p);

    // card inner contains front + back faces; use grid to overlay them (avoids absolute positioning)
    card.innerHTML = `
      <div class="card-inner">
        <div class="card-front">
          ${thumbHtml}
          <h3 class="title">${titleLink}</h3>
          <div class="tags">
            <span class="tag">${escapeHtml(p.category)}</span>
            <span class="tag">${escapeHtml(getFileType(p))}</span>
            ${renderPriceLabel(p)}
          </div>
          ${renderPriceBlock(p)}
          <p class="desc">${escapeHtml(p.description)}</p>
          <div class="card-footer">
            <div class="primary-wrap">${renderPrimaryButton(p)}</div>
            <div class="actions"><button class="details-btn" data-id="${p.id}" aria-label="Details for ${escapeHtml(p.title)}">Details</button></div>
          </div>
        </div>
        <div class="card-back" aria-hidden="true">
          <h3 class="title">${escapeHtml(p.title)}</h3>
          <div style="font-weight:700; color:var(--navy)">${escapeHtml(p.category)}${priceLabel ? ' • ' + escapeHtml(priceLabel) : ''}</div>
          ${renderPriceBlock(p)}
          <p class="desc">${escapeHtml(p.description)}</p>
          <div class="card-footer" style="margin-top:auto;">
            <div class="primary-wrap">${renderPrimaryButton(p)}</div>
            <div class="actions"><button class="back-btn" data-id="${p.id}" aria-label="Back to product">Back</button></div>
          </div>
        </div>
      </div>
    `;
    refs.grid.appendChild(card);

    const img = card.querySelector('.thumb img');
    if(img){
      img.addEventListener('error', ()=> {
        const thumb = card.querySelector('.thumb');
        thumb.innerHTML = thumb.dataset.thumbText || p.thumbText;
      });
      if(img.dataset && img.dataset.failed === '1'){
        const thumb = card.querySelector('.thumb');
        thumb.innerHTML = thumb.dataset.thumbText || p.thumbText;
      }
    }
  });

  // update pagination controls
  renderPagination(totalItems, pageNum, totalPages, pageSize);

  // update SEO: title/meta + JSON-LD + canonical/prev/next
  updateTitleAndMeta();
  injectStructuredData();
  updateCanonicalAndPaginationLinks(pageNum, totalPages, pageSize);

  // update visible H1/description to reflect context
  let h = 'Digital & Physical Products';
  if(refs.categorySelect.value) h = `${cap(refs.categorySelect.value)} — ${h}`;
  if(refs.searchInput.value) h = `Results for "${refs.searchInput.value}" — ${h}`;
  refs.pageH1.textContent = h;
  refs.pageDescEl.textContent = document.title; // quick summary
}

function renderPagination(totalItems, current, totalPages, pageSize){
  if(pageSize === 'all' || totalPages <= 1){
    refs.paginationWrap.style.display = 'none';
    return;
  }
  refs.paginationWrap.style.display = 'flex';
  refs.paginationWrap.innerHTML = '';

  const prev = document.createElement('button'); prev.className='page-btn'; prev.textContent='Prev';
  prev.disabled = current <= 1;
  prev.addEventListener('click', ()=> { if(current > 1){ currentPage--; refreshPage(); } });
  refs.paginationWrap.appendChild(prev);

  if(totalPages <= 10){
      for(let i=1;i<=totalPages;i++){
      const b = document.createElement('button');
      b.className = 'page-btn' + (i===current ? ' active' : '');
      b.textContent = i;
      b.addEventListener('click', ()=> { currentPage = i; refreshPage(); });
      refs.paginationWrap.appendChild(b);
    }
  } else {
    const first = document.createElement('button'); first.className='page-btn'; first.textContent='1';
    first.addEventListener('click', ()=> { currentPage=1; refreshPage(); });
    refs.paginationWrap.appendChild(first);

    if(current > 4){ const dots = document.createElement('span'); dots.textContent='...'; refs.paginationWrap.appendChild(dots); }

    const start = Math.max(2, current - 2);
    const end = Math.min(totalPages - 1, current + 2);
      for(let i=start;i<=end;i++){
      const b = document.createElement('button'); b.className = 'page-btn' + (i===current ? ' active' : '');
      b.textContent = i;
      b.addEventListener('click', ()=> { currentPage = i; refreshPage(); });
      refs.paginationWrap.appendChild(b);
    }

    if(current < totalPages - 3){ const dots2 = document.createElement('span'); dots2.textContent='...'; refs.paginationWrap.appendChild(dots2); }

    const last = document.createElement('button'); last.className='page-btn'; last.textContent=totalPages;
    last.addEventListener('click', ()=>{ currentPage = totalPages; refreshPage(); });
    refs.paginationWrap.appendChild(last);
  }
  const next = document.createElement('button'); next.className='page-btn'; next.textContent='Next';
  next.disabled = current >= totalPages;
  next.addEventListener('click', ()=> { if(current < totalPages){ currentPage++; refreshPage(); } });
  refs.paginationWrap.appendChild(next);

  // Go to page quick-jump
  const goWrap = document.createElement('div'); goWrap.className = 'go-page';
  const goLabel = document.createElement('span'); goLabel.style.color='var(--muted)'; goLabel.textContent='Go to';
  const goInput = document.createElement('input'); goInput.type='number'; goInput.min=1; goInput.max=totalPages; goInput.value=current;
  goInput.setAttribute('aria-label','Page number to go to');
  const goBtn = document.createElement('button'); goBtn.className='page-btn'; goBtn.textContent='Go';
  goBtn.addEventListener('click', ()=> { let v=parseInt(goInput.value,10); if(isNaN(v)) return; if(v<1) v=1; if(v>totalPages) v=totalPages; currentPage=v; refreshPage(); goBtn.blur(); });
  goInput.addEventListener('keydown', (ev)=>{ if(ev.key === 'Enter') goBtn.click(); });
  goWrap.appendChild(goLabel); goWrap.appendChild(goInput); goWrap.appendChild(goBtn);
  refs.paginationWrap.appendChild(goWrap);

  const info = document.createElement('div'); info.style.marginLeft='8px'; info.style.color='var(--muted)';
  info.textContent = `Page ${current} of ${totalPages} • ${totalItems} items`;
  refs.paginationWrap.appendChild(info);
}

/* Apply filters & sorting */
function applyFilters(){
  const q = refs.searchInput.value.toLowerCase().trim();
  const cat = refs.categorySelect.value;
  const price = refs.priceSelect.value;
  const sort = refs.sortSelect.value;

  filteredProducts = PRODUCTS.filter(p => {
    const m1 = !cat || p.category === cat;
    const m2 = !price || (getPriceLabelText(p) || '').toLowerCase() === price;
    const m3 = !q || (p.title + p.description + p.category + (p.seoUrl||'')).toLowerCase().includes(q);
    return m1 && m2 && m3;
  });

  if(sort === 'az') filteredProducts.sort((a,b) => a.title.localeCompare(b.title));
  else if(sort === 'za') filteredProducts.sort((a,b) => b.title.localeCompare(a.title));

  currentPage = 1;
  refreshPage();
}
function refreshPage(){ currentPageSize = refs.pageSizeSelect.value || 'all'; renderProductsPage(filteredProducts, currentPage, currentPageSize); }

/* Event wiring */
refs.searchInput.addEventListener('input', applyFilters);
refs.categorySelect.addEventListener('change', applyFilters);
refs.priceSelect.addEventListener('change', applyFilters);
refs.sortSelect.addEventListener('change', applyFilters);
refs.pageSizeSelect.addEventListener('change', ()=>{ currentPage=1; refreshPage(); });
refs.resetBtn.addEventListener('click', ()=>{ refs.searchInput.value=''; refs.categorySelect.value=''; refs.priceSelect.value=''; refs.sortSelect.value='new'; refs.pageSizeSelect.value='all'; currentPage=1; applyFilters(); });

// Modal removed — card flip replaces modal interactions.

/* Downloads & toast */
function showToast(msg, duration=2500){ if(toastTimer){ clearTimeout(toastTimer); toastTimer=null; } refs.toastEl.textContent = msg; refs.toastEl.classList.add('show'); toastTimer = setTimeout(()=>{ refs.toastEl.classList.remove('show'); toastTimer=null; }, duration); }
function startDownloadById(id){ const p = PRODUCTS.find(x=>x.id === id); if(!p) return; if(p.productUrl){ const a = document.createElement('a'); a.href = p.productUrl; a.download = p.fileName || ''; a.click(); showToast('Download started'); return; } const blob = createDemoFileBlob(p); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = p.fileName || p.title + '.txt'; a.click(); showToast('Download prepared — check your downloads'); setTimeout(()=> URL.revokeObjectURL(url), 4000); }

/* Card flip helpers and delegated grid click */
function flipCard(cardEl){
  if(!cardEl) return;
  // close other flipped cards
  document.querySelectorAll('.card.is-flipped').forEach(c => { if(c !== cardEl) c.classList.remove('is-flipped'); });
  // toggle this card
  const willFlip = !cardEl.classList.contains('is-flipped');
  if(willFlip) cardEl.classList.add('is-flipped'); else cardEl.classList.remove('is-flipped');
}

refs.grid.addEventListener('click', (e)=>{
  const dl = e.target.closest('.download-btn');
  const det = e.target.closest('.details-btn');
  const back = e.target.closest('.back-btn');

  if(dl && dl.dataset.id){
    e.preventDefault();
    startDownloadById(dl.dataset.id);
    return;
  }

  if(back){
    const card = back.closest('.card');
    if(card) card.classList.remove('is-flipped');
    return;
  }

  if(det){
    const card = det.closest('.card');
    if(card) flipCard(card);
    return;
  }
});

/* Go to top */
window.addEventListener('scroll', ()=>{ if(window.scrollY > 300) refs.goTopBtn.classList.add('show'); else refs.goTopBtn.classList.remove('show'); });
refs.goTopBtn.addEventListener('click', ()=> window.scrollTo({ top:0, behavior:'smooth' }));

/* Hidden sitemap generator (Ctrl+Shift+S) */
function buildSitemapXml() {
  const domain = window.location.origin;

  const urls = PRODUCTS.map(p => {
    const loc = p.seoUrl || p.productUrl || `${domain}/product/${p.id}`;
    return `
      <url>
        <loc>${loc}</loc>
        <changefreq>weekly</changefreq>
        <priority>0.8</priority>
      </url>
    `;
  }).join("");

  return `<?xml version="1.0" encoding="UTF-8"?>
  <urlset xmlns="https://www.sitemaps.org/schemas/sitemap/0.9">
    <url>
      <loc>${domain}</loc>
      <changefreq>daily</changefreq>
      <priority>1.0</priority>
    </url>
    ${urls}
  </urlset>`;
}

/* Keyboard shortcut: CTRL + SHIFT + S */
document.addEventListener("keydown", (e) => {
  if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === "s") {

    const xml = buildSitemapXml();
    const blob = new Blob([xml], { type: "application/xml" });
    const url = URL.createObjectURL(blob);

    const win = window.open();
    win.document.write(`
      <pre>${xml.replace(/</g,"&lt;")}</pre>
      <a href="${url}" download="sitemap.xml">Download sitemap.xml</a>
      <p>Upload this file to your site root (/sitemap.xml)</p>
    `);
    win.document.close();

    setTimeout(() => URL.revokeObjectURL(url), 60000);
  }
});

/* Populate filters from PRODUCTS */
(function setupFilters(){
  // Ensure each product has an SEO-friendly URL (`seoUrl`).
  // Auto-generate from `title` when not provided and ensure uniqueness.
  function slugify(s){
    return (s||'').toString().trim().toLowerCase()
      .replace(/["'`]/g,'')
      .replace(/[^a-z0-9\s-]/g,'')
      .replace(/\s+/g,'-')
      .replace(/-+/g,'-')
      .replace(/^[-]+|[-]+$/g,'');
  }
  function ensureSeoUrls(){
    const seen = new Set();
    // pre-seed with provided seoUrls
    PRODUCTS.forEach(p => { if(p.seoUrl) seen.add(p.seoUrl); });
    PRODUCTS.forEach(p => {
      if(!p.seoUrl || !String(p.seoUrl).trim()){
        const base = '/product/' + slugify(p.title || p.id || '') || ('product-' + p.id);
        let candidate = base;
        let i = 1;
        while(seen.has(candidate)){
          candidate = base + '-' + i; i++;
        }
        p.seoUrl = candidate;
        seen.add(candidate);
      }
    });
  }
  ensureSeoUrls();
  const cats = [...new Set(PRODUCTS.map(p => p.category))].sort();
  cats.forEach(c => { const op = document.createElement('option'); op.value = c; op.textContent = c; refs.categorySelect.appendChild(op); });

  const prices = [...new Set(PRODUCTS.map(p => (getPriceLabelText(p) || 'unknown').toLowerCase()))].filter(Boolean).sort();
  prices.forEach(pv => { const op = document.createElement('option'); op.value = pv; op.textContent = cap(pv); refs.priceSelect.appendChild(op); });

  // initial SEO injection
  updateTitleAndMeta();
  injectStructuredData();
})();

/* INITIAL LOAD */
applyFilters();
// expose minimal API
window.setTheme = setTheme;

})();
</script>
