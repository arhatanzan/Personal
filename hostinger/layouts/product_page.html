<style>
  /* Theme variables — change these to update site colors quickly */
  :root {
    --page-bg: #f8f6f2;
    --card-bg: #ffffff;
    --white: #ffffff;
    --accent: #d4a017;
    --navy: #0a2342;
    --navy-rgb: 10, 34, 66; /* use with rgba(var(--navy-rgb),a) */
    --muted: #5a6673;
    --paid-bg: #7a2e2e;
    --label-free-bg: var(--navy);
    --label-free-text: var(--page-bg);
    --label-paid-bg: var(--paid-bg);
    --label-paid-text: var(--page-bg);
    --border: rgba(0, 0, 0, 0.06);
    --radius: 10px;
    --gap: 18px;
    --container: 1200px;
    --thumb-grad-1: #ececec;
  }

  * {
    box-sizing: border-box;
  }
  body,
  html {
    margin: 0;
    padding: 0;
    font-family: Calibri, Arial, sans-serif;
    background: var(--page-bg);
    color: var(--navy);
  }
  .prod-wrap {
    max-width: var(--container);
    margin: 28px auto;
    padding: 20px;
  }
  /* Stack header vertically and left-align contents for a precise layout */
  .prod-header {
    display: flex;
    flex-direction: column;
    gap: 8px;
    align-items: flex-start;
    margin-bottom: 12px;
  }
  .prod-title h1 {
    margin: 0;
    font-size: 32px;
    line-height: 1.05;
    color: var(--navy);
    font-weight: 700;
    letter-spacing: -0.2px;
  }
  .prod-sub {
    color: var(--muted);
    font-size: 14px;
    margin: 6px 0 0; /* add space below heading */
  }
  /* Stack search above filters; keep controls right-aligned */
  .prod-controls {
    display: flex;
    flex-direction: column;
    gap: 8px;
    align-items: flex-end;
    width: 100%;
  }

  /* Controls */
  /* Search sits on its own row and is left-most */
  .search {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--white);
    border-radius: 8px;
    padding: 8px 10px;
    flex: 0 0 auto;
    max-width: 480px;
    min-width: 200px;
  }
  .search input {
    border: 0;
    outline: 0;
    width: 100%;
    font-size: 14px;
    color: var(--navy);
    background: transparent;
  }

  /* Grouped row for filters + reset button (placed under search) */
  .controls-row {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
    width: auto;
    margin-top: 0;
    justify-content: flex-end;
  }
  .select,
  .btn {
    background: var(--white);
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 14px;
    border: 1px solid var(--border);
  }
  .btn {
    cursor: pointer;
  }
  .btn.primary {
    background: var(--accent);
    color: var(--navy);
    font-weight: 600;
  }

  /* Make reset button stand out: navy background, white text, and add tactile click effect */
  #resetBtn {
    background: var(--navy);
    color: var(--white);
    border: 1px solid var(--navy);
    font-weight: 600;
    transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease;
    box-shadow: 0 6px 12px rgba(10, 34, 66, 0.08);
  }
  #resetBtn:hover {
    opacity: 0.95;
  }
  #resetBtn:active {
    transform: translateY(1px) scale(0.996);
    box-shadow: 0 3px 8px rgba(10, 34, 66, 0.06);
  }

  /* Grid & Cards */
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: var(--gap);
    margin-top: 18px;
  }
  .card {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 16px;
    border: 4px solid var(--accent);
    display: flex;
    flex-direction: column;
    gap: 12px;
    height: 320px;
    overflow: hidden;
  }
  .thumb {
    height: 110px;
    border-radius: 6px;
    background: linear-gradient(180deg, var(--thumb-grad-1), var(--white));
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: var(--muted);
    position: relative;
    overflow: hidden;
  }
  .thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    border-radius: 6px;
  }
  .title {
    font-size: 16px;
    font-weight: 700;
    margin: 0;
    color: var(--navy);
  }
  .title a {
    color: inherit;
    text-decoration: none;
  }
  .desc {
    font-size: 14px;
    color: var(--muted);
    margin: 0;
    line-height: 1.4;
  }
  .tags {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 4px;
  }
  .tag {
    border: 1px solid rgba(0, 0, 0, 0.1);
    padding: 3px 8px;
    border-radius: 999px;
    font-size: 12px;
  }
  .label-free {
    background: var(--label-free-bg);
    color: var(--label-free-text);
    border-radius: 999px;
    padding: 3px 8px;
    font-size: 12px;
  }
  .label-paid {
    background: var(--label-paid-bg);
    color: var(--label-paid-text);
    border-radius: 999px;
    padding: 3px 8px;
    font-size: 12px;
  }
  .card-footer {
    margin-top: auto;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .card-footer .primary-wrap {
    flex: 1 1 auto;
  }
  .card-footer .actions {
    flex: 0 0 auto;
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .card-footer .actions {
    margin-left: auto;
  }
  .download-btn {
    background: var(--accent);
    color: var(--navy);
    border-radius: 8px;
    padding: 8px 12px;
    text-decoration: none;
    font-weight: 700;
    font-size: 14px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  /* Downloaded state styling */
  .download-btn.downloaded {
    background: var(--navy);
    color: var(--page-bg);
    border-color: var(--navy);
  }
  /* unify action buttons (Details / Back) so they're visually identical and align perfectly */
  .details-btn,
  .back-btn {
    background: transparent;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    padding: 6px 12px;
    font-size: 14px;
    cursor: pointer;
    color: var(--navy);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 86px;
    box-sizing: border-box;
  }
  .empty {
    text-align: center;
    color: var(--muted);
    padding: 40px 0;
  }

  /* SEO helper button (sitemap) */
  #sitemapBtn {
    background: var(--white);
    border-radius: 8px;
    border: 1px solid var(--border);
    padding: 8px 10px;
    cursor: pointer;
  }

  /* Go To Top Button */
  #goTopBtn {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--accent);
    color: var(--navy);
    border: none;
    padding: 12px 16px;
    font-size: 14px;
    font-weight: 700;
    border-radius: 10px;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s ease;
    z-index: 9999;
  }
  #goTopBtn.show {
    opacity: 1;
    pointer-events: all;
  }

  /* Pagination */
  .pagination-wrap {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    margin-top: 18px;
    flex-wrap: wrap;
  }
  .page-btn {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 6px 10px;
    cursor: pointer;
  }
  .page-btn.active {
    background: var(--navy);
    color: var(--white);
    border-color: var(--navy);
  }
  .go-page {
    display: flex;
    gap: 6px;
    align-items: center;
    margin-left: 8px;
  }
  .go-page input {
    width: 64px;
    padding: 6px 8px;
    border-radius: 6px;
    border: 1px solid var(--border);
  }


  /* Card flip: use grid-based overlap (avoids absolute/fixed positioning) */
  .card {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 0;
    border: 4px solid var(--accent);
    display: flex;
    flex-direction: column;
    gap: 0; /* height set dynamically via JS */
    overflow: hidden;
    perspective: 1000px;
  }
  .card-inner {
    transition: transform 0.5s ease;
    transform-style: preserve-3d;
    display: grid;
    width: 100%;
    height: 100%;
  }
  .card-front,
  .card-back {
    grid-area: 1/1;
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 16px;
    box-sizing: border-box;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    height: 100%;
  }
  .card-front {
    background: transparent;
  }
  .card-back {
    background: var(--card-bg);
    color: var(--navy);
    transform: rotateY(180deg);
    border-radius: calc(var(--radius) - 2px);
    align-items: flex-start;
    min-height: 0;
    overflow: hidden;
  }
  /* Ensure the description on the back of the card scrolls if content overflows */
  .card-back .desc {
    flex: 1 1 auto;
    overflow-y: auto;
    min-height: 0;
  }
  /* Ensure the footer on the back face stretches full width so actions can be pushed right */
  .card-back .card-footer {
    width: 100%;
  }
  .card.is-flipped .card-inner {
    transform: rotateY(180deg);
  }

  /* Price display */
  .price-row {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-top: 8px;
  }
  .price-old {
    text-decoration: line-through;
    color: var(--muted);
    font-size: 13px;
  }
  .price-now {
    font-weight: 800;
    color: var(--navy);
    font-size: 15px;
  }
  .discount-badge {
    background: var(--accent);
    color: var(--navy);
    border-radius: 8px;
    padding: 4px 6px;
    font-size: 12px;
    font-weight: 700;
  }

  @media (max-width: 1000px) {
    .search {
      max-width: 420px;
    }
    .prod-title h1 {
      font-size: 28px;
    }
  }
  @media (max-width: 600px) {
    .search {
      max-width: 100%;
      flex: 1 1 100%;
      min-width: 0;
    }
    .controls-row {
      width: 100%;
      justify-content: flex-start;
      margin-top: 6px;
    }
    .search input {
      width: 130px;
    }
    .prod-title h1 {
      font-size: 22px;
    }
    .card {
      min-height: 200px;
    }
    .card-back {
      max-height: none;
    }
  }
</style>

<div class="prod-wrap" aria-live="polite">
  <div class="prod-header">
    <div class="prod-title">
      <h1 id="pageH1">Digital & Physical Products</h1>
      <div id="pageDesc" class="prod-sub">
        Instant downloads + external store products - No Sign Required
      </div>
    </div>

    <div class="prod-controls" id="controls">
      <div class="search">
        <input
          id="searchInput"
          placeholder="Search products…"
          aria-label="Search products"
        />
      </div>

      <div class="controls-row">
        <select
          id="categorySelect"
          class="select"
          aria-label="Filter by category"
        >
          <option value="">All categories</option>
        </select>

        <select id="priceSelect" class="select" aria-label="Filter by price">
          <option value="">All prices</option>
        </select>

        <select
          id="pageSizeSelect"
          class="select"
          title="Items per page"
          aria-label="Items per page"
        >
          <option value="all">All (default)</option>
          <option value="10">10 / page</option>
          <option value="30">30 / page</option>
          <option value="50">50 / page</option>
          <option value="100">100 / page</option>
        </select>

        <select id="sortSelect" class="select" aria-label="Sort products">
          <option value="new">Newest</option>
          <option value="az">A → Z</option>
          <option value="za">Z → A</option>
        </select>

        <button id="resetBtn" class="btn" aria-label="Reset filters">
          Reset
        </button>
      </div>
    </div>
  </div>

  <div id="grid" class="grid"></div>
  <div id="empty" class="empty" style="display: none">No products found.</div>

  <div id="pagination" class="pagination-wrap" style="display: none"></div>
</div>

<button id="goTopBtn" aria-label="Go to top">↑ Top</button>


<script>
  (function () {
    "use strict";
    const SITE_BASE =
      (window.SITE_BASE_URL && window.SITE_BASE_URL.replace(/\/$/, "")) ||
      location.origin.replace(/\/$/, "");
    const LISTING_PATH = "/products"; // relative path for listing pages in sitemap/canonical (change if needed)

    /*
  THEME HELPER
  If you want to change colors at runtime without editing the CSS, call
    setTheme({ '--accent': '#ff6600', '--navy': '#002244' });
  It updates CSS custom properties on :root and keeps the file self-contained.
*/
    function setTheme(vars) {
      if (!vars || typeof vars !== "object") return;
      const root = document.documentElement;
      Object.keys(vars).forEach((k) => {
        try {
          root.style.setProperty(k, vars[k]);
        } catch (e) {}
      });
    }

    /* PRODUCT DATA - edit entries below as needed */
    const PRODUCTS = [
      {
        id: "101",
        summary: "Using storytelling to deliver impactful presentations",
        buttonLabel: "Download",
        category: "Slides",
        description:
          "A focused approach to crafting compelling narratives that engage audiences and strengthen message delivery.",
        discountPercent: 100,
        fileName: "art-of-storytelling-for-effective-presentation.pptx",
        imageUrl: "https://drive.google.com/thumbnail?id=1cxqthd8oKgy2DSwIedGSSCSiFNHnx7fE",
        originalPrice: 100,
        priceCurrency: "INR",
        productUrl:
          "https://drive.google.com/uc?export=download&id=1cxqthd8oKgy2DSwIedGSSCSiFNHnx7fE",
        seoUrl: "/product/art-of-storytelling-for-effective-presentation",
        thumbText: "Slides",
        title: "Art of Storytelling for Effective Presentation",
        type: "download",
      },
      {
        id: "102",
        summary: "How lies and manipulation shape political narratives",
        buttonLabel: "Buy on Amazon",
        category: "Books",
        description:
          "An analytical overview of deception in politics, propaganda tactics, and their impact on democracy and public trust.",
        discountPercent: 10,
        fileName: "political-dacoity.pptx",
        imageUrl: "https://m.media-amazon.com/images/I/71mjn4mKNaL._AC_UY327_FMwebp_QL65_.jpg",
        originalPrice: 300,
        priceCurrency: "INR",
        productUrl: "https://www.amazon.in/dp/B0D2PB67HJ",
        seoUrl: "/product/political-dacoity",
        thumbText: "Books",
        title: "Political Dacoity",
        type: "external",
      },
      {
        id: "103",
        summary: "Strategies to balance personal & professional life remotely",
        buttonLabel: "Download",
        category: "Slides",
        description:
          "Insights for managing stress, prioritizing well-being, and maintaining a healthy work-life balance in remote work settings.",
        discountPercent: 100,
        fileName: "work-life-balance-durnig-remote-work.pptx",
        imageUrl: "https://drive.google.com/thumbnail?id=1dqjPCnwNxyIkvAriWSAuR0o2yLcMzqEz",
        originalPrice: 100,
        priceCurrency: "INR",
        productUrl:
          "https://drive.google.com/uc?export=download&id=1dqjPCnwNxyIkvAriWSAuR0o2yLcMzqEz",
        seoUrl: "/product/work-life-balance-during-remote-work",
        thumbText: "Slides",
        title: "Work-Life Balance During Remote Work",
        type: "download",
      },
      {
        id: "104",
        summary: "Hidden emotions expressed through poetic words",
        buttonLabel: "Buy on Amazon",
        category: "Books",
        description:
          "Urdu writings transliterated into Hindi, capturing emotions and reflections through ghazals and heartfelt verses.",
        discountPercent: 5,
        fileName: "sirr-e-nihaan.pptx",
        imageUrl: "https://m.media-amazon.com/images/I/61JNmpunFLL._AC_UY327_FMwebp_QL65_.jpg",
        originalPrice: 100,
        priceCurrency: "INR",
        productUrl: "https://www.amazon.in/dp/1685540112",
        seoUrl: "/product/sirr-e-nihaan",
        thumbText: "Books",
        title: "Sirr-e-Nihaan",
        type: "external",
      },
      {
        id: "105",
        summary: "Poetry exploring love, longing & inner emotions",
        buttonLabel: "Buy on Amazon",
        category: "Books",
        description:
          "Expressive Urdu poetry transliterated into Hindi, portraying love, introspection, and human connection.",
        discountPercent: 5,
        fileName: "sirr-e-ulfat.pptx",
        imageUrl: "https://m.media-amazon.com/images/I/61jIIrsLbfL._AC_UY327_FMwebp_QL65_.jpg",
        originalPrice: 150,
        priceCurrency: "INR",
        productUrl: "https://www.amazon.in/dp/1639402292",
        seoUrl: "/product/sirr-e-ulfat",
        thumbText: "Books",
        title: "Sirr-e-Ulfat",
        type: "external",
      },
      {
        id: "106",
        summary: "Improving communication for better teamwork & productivity",
        buttonLabel: "Download",
        category: "Slides",
        description:
          "A practical guide to effective workplace communication, conflict resolution, and strong collaboration.",
        discountPercent: 100,
        fileName: "communication-at-workplace.pptx",
        imageUrl: "https://drive.google.com/thumbnail?id=1oAk6fackAeTqfeEhNQVDh0FNO2wYv4oL",
        originalPrice: 100,
        priceCurrency: "INR",
        productUrl:
          "https://drive.google.com/uc?export=download&id=1oAk6fackAeTqfeEhNQVDh0FNO2wYv4oL",
        seoUrl: "/product/communication-at-workplace",
        thumbText: "Slides",
        title: "Communication at Workplace",
        type: "download",
      },
      {
        id: "107",
        summary: "Raw reflections on love, pain & healing",
        buttonLabel: "Buy on Amazon",
        category: "Books",
        description:
          "A deeply emotional collection exploring loneliness, unreciprocated care, and the search for solace.",
        discountPercent: 5,
        fileName: "un-erased-emotions-last.pptx",
        imageUrl: "https://m.media-amazon.com/images/I/51k1NZ4eKyL._AC_UY327_FMwebp_QL65_.jpg",
        originalPrice: 150,
        priceCurrency: "INR",
        productUrl: "https://www.amazon.in/dp/B0BSV4J5YY",
        seoUrl: "/product/un-erased-emotions-last",
        thumbText: "Books",
        title: "Un(Erased): Emotions Last",
        type: "external",
      },
    ];

    /* DOM refs (cached) */
    const refs = {
      grid: document.getElementById("grid"),
      empty: document.getElementById("empty"),
      paginationWrap: document.getElementById("pagination"),
      categorySelect: document.getElementById("categorySelect"),
      priceSelect: document.getElementById("priceSelect"),
      pageSizeSelect: document.getElementById("pageSizeSelect"),
      searchInput: document.getElementById("searchInput"),
      sortSelect: document.getElementById("sortSelect"),
      resetBtn: document.getElementById("resetBtn"),
      goTopBtn: document.getElementById("goTopBtn"),
      pageH1: document.getElementById("pageH1"),
      pageDescEl: document.getElementById("pageDesc"),
    };

    // Note: use `refs.*` for DOM access throughout the file.

    let filteredProducts = []; // Holds products after filtering, before pagination.
    let currentPage = 1;
    let currentPageSize = "all";
    

    /* --- HELPERS --- */
    function escapeHtml(s) {
      return (s || "").toString().replace(/&/g, "&amp;").replace(/</g, "&lt;");
    }
    function cap(s) {
      return (s || "").charAt(0).toUpperCase() + (s || "").slice(1);
    }
    /**
     * Returns a short summary for the card's front face.
     * Prefers the explicit `summary` field, otherwise derives from `description`.
     */
    function getSummary(p) {
      if (!p) return "";
      if (p.summary && String(p.summary).trim())
        return String(p.summary).trim();
      const s = (p.description || "").toString().trim();
      if (!s) return "";
      // Try to use the first sentence if it's a reasonable length.
      const first = s.split(/[\.?!]\s/)[0];
      if (first && first.length <= 160)
        return first + (/[\.?!]$/.test(first) ? "" : "...");
      // Fallback to a simple truncation.
      return s.length > 140 ? s.slice(0, 140).trim() + "..." : s;
    }

    /* --- SEO & METADATA --- */

    /**
     * Ensures a <meta> tag exists in the <head> with the specified name/property and value.
     * Creates the tag if it doesn't exist, otherwise updates it.
     * @param {string} nameOrProp - The meta tag's `name` or `property` attribute.
     * @param {string} value - The value for the `content` attribute.
     * @param {boolean} isProperty - Set to true if `nameOrProp` is a `property` (e.g., 'og:title').
     */
    function ensureMetaTag(nameOrProp, value, isProperty = false) {
      let selector = isProperty
        ? `meta[property="${nameOrProp}"]`
        : `meta[name="${nameOrProp}"]`;
      let m = document.head.querySelector(selector);
      if (!m) {
        m = document.createElement("meta");
        if (isProperty) m.setAttribute("property", nameOrProp);
        else m.setAttribute("name", nameOrProp);
        document.head.appendChild(m);
      }
      m.setAttribute("content", value || "");
    }

    /**
     * Ensures a <link> tag with a given `rel` attribute exists and sets its `href`.
     * @param {string} rel - The `rel` attribute value (e.g., 'canonical').
     * @param {string} href - The `href` attribute value.
     */
    function ensureLinkRel(rel, href) {
      let el = document.head.querySelector(`link[rel="${rel}"]`);
      if (!el) {
        el = document.createElement("link");
        el.setAttribute("rel", rel);
        document.head.appendChild(el);
      }
      el.setAttribute("href", href || "");
    }

    /**
     * Updates the page title and meta tags based on current filters and search query.
     * This makes the page SEO-friendly and improves user context.
     */
    function updateTitleAndMeta() {
      const parts = [];
      const cat = refs.categorySelect.value;
      const price = refs.priceSelect.value;
      const q = refs.searchInput.value.trim();

      if (q) parts.push(`"${q}"`);
      if (cat) parts.push(cap(cat));
      if (price) parts.push(cap(price));
      parts.push("Digital & Physical Products");
      const title = parts.join(" | ");
      document.title = title;

      const descParts = [];
      if (cat) descParts.push(`${cap(cat)} products`);
      if (price) descParts.push(`${cap(price)} items`);
      if (q) descParts.push(`Search results for "${q}"`);
      descParts.push("Instant downloads, external store links, and templates.");
      const description = descParts.join(" • ");

      // Update standard and social media meta tags for SEO.
      ensureMetaTag("description", description);
      ensureMetaTag("robots", "index,follow");
      ensureMetaTag("twitter:card", "summary_large_image");
      ensureMetaTag("twitter:title", title);
      ensureMetaTag("twitter:description", description);
      ensureMetaTag("og:title", title, true);
      ensureMetaTag("og:description", description, true);
      ensureMetaTag("og:type", "website", true);
      ensureMetaTag(
        "og:site_name",
        document.location.hostname || SITE_BASE,
        true
      );
      // Set a fallback Open Graph/Twitter image.
      ensureMetaTag("og:image", `${SITE_BASE}/assets/og-products.jpg`, true);
      ensureMetaTag("twitter:image", `${SITE_BASE}/assets/og-products.jpg`);
    }

    /**
     * Updates canonical, prev, and next link tags for paginated results.
     * This helps search engines understand the paginated structure of the content.
     */
    function updateCanonicalAndPaginationLinks(pageNum, totalPages, pageSize) {
      const urlBase =
        SITE_BASE +
        (LISTING_PATH.startsWith("/") ? LISTING_PATH : "/" + LISTING_PATH);
      const params = new URLSearchParams();
      if (pageNum && pageNum > 1) params.set("page", pageNum);
      if (pageSize && pageSize !== "all") params.set("pageSize", pageSize);
      const canonicalHref = params.toString()
        ? `${urlBase}?${params.toString()}`
        : urlBase;

      ensureLinkRel("canonical", canonicalHref);

      // Set or remove 'prev' link
      if (pageNum > 1) {
        const prevParams = new URLSearchParams();
        const prevPage = pageNum - 1;
        if (prevPage > 1) prevParams.set("page", prevPage);
        if (pageSize && pageSize !== "all")
          prevParams.set("pageSize", pageSize);
        ensureLinkRel(
          "prev",
          prevParams.toString()
            ? `${urlBase}?${prevParams.toString()}`
            : urlBase
        );
      } else {
        const prevEl = document.head.querySelector('link[rel="prev"]');
        if (prevEl) prevEl.remove();
      }

      // Set or remove 'next' link
      if (pageNum < totalPages) {
        const nextParams = new URLSearchParams();
        const nextPage = pageNum + 1;
        if (nextPage > 1) nextParams.set("page", nextPage);
        if (pageSize && pageSize !== "all")
          nextParams.set("pageSize", pageSize);
        ensureLinkRel(
          "next",
          nextParams.toString()
            ? `${urlBase}?${nextParams.toString()}`
            : urlBase
        );
      } else {
        const nextEl = document.head.querySelector('link[rel="next"]');
        if (nextEl) nextEl.remove();
      }
    }

    /**
     * Injects JSON-LD structured data for products into the page header.
     * This helps search engines understand product details like name, price, and offers.
     */
    function injectStructuredData() {
      const items = PRODUCTS.map((p) => {
        const node = {
          "@type": "Product",
          name: p.title,
          description: p.description,
        };

        // Use the SEO-friendly URL if available.
        const urlSource = p.seoUrl || p.productUrl;
        if (urlSource) {
          node.url = urlSource.startsWith("http")
            ? urlSource
            : SITE_BASE +
              (urlSource.startsWith("/") ? urlSource : "/" + urlSource);
        }
        if (p.imageUrl)
          node.image = p.imageUrl.startsWith("http")
            ? p.imageUrl
            : SITE_BASE +
              (p.imageUrl.startsWith("/") ? p.imageUrl : "/" + p.imageUrl);

        // Safely parse price and discount to generate structured data for offers.
        function toNumber(s) {
          if (s === undefined || s === null || s === "") return NaN;
          const n = Number(String(s).replace(/,/g, ""));
          return isNaN(n) ? NaN : n;
        }
        const origNum = toNumber(p.originalPrice);
        const disc =
          typeof p.discountPercent === "number"
            ? p.discountPercent
            : p.discountPercent
            ? Number(p.discountPercent)
            : NaN;

        if (!isNaN(origNum)) {
          const curr = p.priceCurrency || "INR";
          if (!isNaN(disc)) {
            const safeDisc = Math.max(0, Math.min(100, disc));
            const priceNowNum = +(origNum * (1 - safeDisc / 100)).toFixed(2);
            node.offers = {
              "@type": "Offer",
              price: priceNowNum.toFixed(2),
              priceCurrency: p.priceCurrency || "INR",
              availability: "https://schema.org/InStock",
            };
            // Also include the original price for context.
            node.priceSpecification = {
              "@type": "PriceSpecification",
              priceCurrency: p.priceCurrency || "INR",
              price: origNum.toFixed(2),
            };
          } else {
            node.offers = {
              "@type": "Offer",
              price: origNum.toFixed(2),
              priceCurrency: p.priceCurrency || "INR",
              availability: "https://schema.org/InStock",
            };
            node.priceSpecification = {
              "@type": "PriceSpecification",
              priceCurrency: p.priceCurrency || "INR",
              price: origNum.toFixed(2),
            };
          }
        } else {
          // If no price, still include an Offer to indicate availability.
          node.offers = {
            "@type": "Offer",
            availability: "https://schema.org/InStock",
          };
        }

        return node;
      });

      const graph = { "@context": "https://schema.org", "@graph": items };
      let existing = document.getElementById("__products_jsonld");
      if (existing) existing.textContent = JSON.stringify(graph);
      else {
        const s = document.createElement("script");
        s.type = "application/ld+json";
        s.id = "__products_jsonld";
        s.textContent = JSON.stringify(graph);
        document.head.appendChild(s);
      }
    }

    /* --- UI RENDERING & INTERACTIONS --- */

    function getFileType(prod) {
      if (prod.type === "external") return "LINK";
      if (prod.fileName) return prod.fileName.split(".").pop().toUpperCase();
      return "FILE";
    }
    function createDemoFileBlob(p) {
      const txt = `${p.title}\n---\n${
        p.description
      }\nGenerated: ${new Date().toLocaleString()}`;
      return new Blob([txt], { type: "text/plain" });
    }
    function renderPrimaryButton(prod) {
      if (prod.type === "download") {
        return `<a class="download-btn" data-id="${
          prod.id
        }" href="#" aria-label="Download ${escapeHtml(
          prod.title
        )}">Download</a>`;
      }
      if (prod.type === "external") {
        const label = prod.buttonLabel || "Buy Now";
        const href = prod.productUrl || "#";
        return `<a class="download-btn" href="${escapeHtml(
          href
        )}" target="_blank" rel="noopener" aria-label="${escapeHtml(
          label
        )}">${escapeHtml(label)}</a>`;
      }
      return "";
    }
    /**
     * Determines if a product is 'FREE' or 'PAID' based on its price and discount.
     */
    function getPriceLabelText(prod) {
      function toNumber(s) {
        if (s === undefined || s === null || s === "") return NaN;
        const n = Number(String(s).replace(/,/g, ""));
        return isNaN(n) ? NaN : n;
      }
      const orig = toNumber(prod.originalPrice);
      const disc =
        typeof prod.discountPercent === "number"
          ? prod.discountPercent
          : prod.discountPercent
          ? Number(prod.discountPercent)
          : NaN;

      if (!isNaN(orig)) {
        if (!isNaN(disc)) {
          const safeDisc = Math.max(0, Math.min(100, disc));
          const priceNow = +(orig * (1 - safeDisc / 100)).toFixed(2);
          if (priceNow === 0 || safeDisc === 100) return "FREE";
          return "PAID";
        }
        return orig === 0 ? "FREE" : "PAID";
      }

      // Return empty if price is not specified
      return "";
    }

    /**
     * Renders a 'FREE' or 'PAID' badge based on the product's price.
     */
    function renderPriceLabel(prod) {
      const txt = getPriceLabelText(prod);
      if (txt === "FREE") return `<span class="label-free">FREE</span>`;
      if (txt === "PAID") return `<span class="label-paid">PAID</span>`;
      if (txt) return `<span class="tag">${escapeHtml(txt)}</span>`;
      return "";
    }

    /**
     * Formats a numeric value as a currency string (e.g., ₹1,234.56).
     * Defaults to INR but supports other currency codes.
     */
    function formatCurrency(v, currency) {
      const curr = (currency && String(currency).trim()) || "INR";
      const n = Number(String(v).replace(/,/g, ""));
      if (isNaN(n)) {
        try {
          // Show zero in the requested currency format.
          return new Intl.NumberFormat("en-US", {
            style: "currency",
            currency: curr,
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          }).format(0);
        } catch (e) {
          return curr === "INR" ? "₹0.00" : `${curr}0.00`;
        }
      }
      try {
        // Use a locale that matches the currency for better formatting.
        const locale =
          curr === "INR" ? "en-IN" : curr === "USD" ? "en-US" : "en-US";
        return new Intl.NumberFormat(locale, {
          style: "currency",
          currency: curr,
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        }).format(n);
      } catch (e) {
        // Fallback for unsupported currency codes.
        if (curr === "INR") return "₹" + n.toFixed(2);
        return curr + " " + n.toFixed(2);
      }
    }

    /**
     * Renders the price block, showing the current price and any applicable discount.
     */
    function renderPriceBlock(p) {
      function toNumber(s) {
        if (s === undefined || s === null || s === "") return NaN;
        const n = Number(String(s).replace(/,/g, ""));
        return isNaN(n) ? NaN : n;
      }

      const origNum = toNumber(p.originalPrice);
      const disc =
        typeof p.discountPercent === "number"
          ? p.discountPercent
          : p.discountPercent
          ? Number(p.discountPercent)
          : NaN;
      const curr = p.priceCurrency || "INR";
      // Case 1: Valid original price and discount percentage.
      if (!isNaN(origNum) && !isNaN(disc)) {
        const safeDisc = Math.max(0, Math.min(100, disc));
        const priceNowNum = +(origNum * (1 - safeDisc / 100)).toFixed(2);
        // If 100% off, show as FREE.
        if (safeDisc === 100) {
          const origHtml = `<span class="price-old">${escapeHtml(
            formatCurrency(origNum, curr)
          )}</span>`;
          return `<div class="price-row">${origHtml}<span class="price-now">FREE</span><span class="discount-badge">${safeDisc}% OFF</span></div>`;
        }
        // Otherwise, show discounted price.
        const origHtml = `<span class="price-old">${escapeHtml(
          formatCurrency(origNum, curr)
        )}</span>`;
        const nowHtml = `<span class="price-now">${escapeHtml(
          formatCurrency(priceNowNum, curr)
        )}</span>`;
        return `<div class="price-row">${origHtml}${nowHtml}<span class="discount-badge">${safeDisc}% OFF</span></div>`;
      }

      // Case 2: Valid original price but no discount.
      if (!isNaN(origNum) && (isNaN(disc) || disc === 0)) {
        return `<div class="price-row"><span class="price-now">${escapeHtml(
          formatCurrency(origNum, curr)
        )}</span></div>`;
      }

      // Case 3: No reliable pricing info.
      return "";
    }
    /**
     * Renders the list of products for the current page.
     * Handles pagination logic and updates the grid.
     */
    function renderProductsPage(list, page, pageSize) {
      refs.grid.innerHTML = "";

      if (!list.length) {
        refs.empty.style.display = "block";
        refs.paginationWrap.style.display = "none";
        updateTitleAndMeta();
        injectStructuredData();
        updateCanonicalAndPaginationLinks(1, 1, "all");
        return;
      }
      refs.empty.style.display = "none";

      let pageNum = parseInt(page, 10) || 1;
      let size = pageSize === "all" ? list.length : parseInt(pageSize, 10);
      const totalItems = list.length;
      const totalPages =
        size === 0 ? 1 : Math.max(1, Math.ceil(totalItems / size));
      if (pageNum > totalPages) pageNum = totalPages;
      const start = pageSize === "all" ? 0 : (pageNum - 1) * size;
      const end =
        pageSize === "all" ? totalItems : Math.min(totalItems, start + size);
      const slice = list.slice(start, end);

      slice.forEach((p) => {
        const card = document.createElement("div");
        card.className = "card";

        // Image fallback: use `imageUrl` if present, otherwise show `thumbText`.
        let thumbHtml = `<div class="thumb" aria-hidden="true">${escapeHtml(
          p.thumbText
        )}</div>`;
        if (p.imageUrl) {
          const imgSrc = escapeHtml(p.imageUrl);
          thumbHtml = `<div class="thumb" data-thumb-text="${escapeHtml(
            p.thumbText
          )}"><img src="${imgSrc}" alt="${escapeHtml(
            p.title
          )} thumbnail" loading="lazy" onerror="this.dataset.failed='1'; this.style.display='none'; this.parentNode.classList.add('thumb-failed');"></div>`;
        }

        const titleHref = p.seoUrl || p.productUrl || "";
        const titleLink = titleHref
          ? `<a href="${escapeHtml(titleHref)}">${escapeHtml(p.title)}</a>`
          : `<span>${escapeHtml(p.title)}</span>`;

        const priceLabel = getPriceLabelText(p);

        // The card's inner structure contains front and back faces for the flip effect.
        card.innerHTML = `
      <div class="card-inner">
        <div class="card-front">
          ${thumbHtml}
          <h3 class="title">${titleLink}</h3>
          <div class="tags">
            <span class="tag">${escapeHtml(p.category)}</span>
            <span class="tag">${escapeHtml(getFileType(p))}</span>
            ${renderPriceLabel(p)}
          </div>
          ${renderPriceBlock(p)}
          <p class="desc">${escapeHtml(getSummary(p))}</p>
          <div class="card-footer">
            <div class="primary-wrap">${renderPrimaryButton(p)}</div>
            <div class="actions"><button class="details-btn" data-id="${
              p.id
            }" aria-label="Details for ${escapeHtml(
          p.title
        )}">Details</button></div>
          </div>
        </div>
        <div class="card-back" aria-hidden="true">
          <p class="desc">${escapeHtml(p.description)}</p>
          <div class="card-footer" style="margin-top:auto;">
            <div class="primary-wrap">${renderPrimaryButton(p)}</div>
            <div class="actions"><button class="back-btn" data-id="${
              p.id
            }" aria-label="Back to product">Back</button></div>
          </div>
        </div>
      </div>
    `;
        refs.grid.appendChild(card);

        // Handle broken image links gracefully by showing the thumb text.
        const img = card.querySelector(".thumb img");
        if (img) {
          img.addEventListener("error", () => {
            const thumb = card.querySelector(".thumb");
            thumb.innerHTML = thumb.dataset.thumbText || p.thumbText;
          });
          if (img.dataset && img.dataset.failed === "1") {
            const thumb = card.querySelector(".thumb");
            thumb.innerHTML = thumb.dataset.thumbText || p.thumbText;
          }
        }
      });

      renderPagination(totalItems, pageNum, totalPages, pageSize);

      // Update all SEO and metadata after rendering.
      updateTitleAndMeta();
      injectStructuredData();
      updateCanonicalAndPaginationLinks(pageNum, totalPages, pageSize);

      // Update the visible H1 and description only if auto-update is enabled.
      // To enable, set `data-auto="true"` on the respective element.
      const shouldAutoH1 = refs.pageH1 && refs.pageH1.dataset.auto === "true";
      const shouldAutoDesc =
        refs.pageDescEl && refs.pageDescEl.dataset.auto === "true";

      if (shouldAutoH1) {
        let h = "Digital & Physical Products";
        if (refs.categorySelect.value)
          h = `${cap(refs.categorySelect.value)} — ${h}`;
        if (refs.searchInput.value)
          h = `Results for "${refs.searchInput.value}" — ${h}`;
        refs.pageH1.textContent = h;
      }

      if (shouldAutoDesc) {
        refs.pageDescEl.textContent = document.title; // Use the dynamic title as a sub-header.
      }

      // After rendering, normalize card heights to the tallest front face.
      requestAnimationFrame(adjustCardHeights);
    }

    /**
     * Renders pagination controls based on the total number of items and pages.
     */
    function renderPagination(totalItems, current, totalPages, pageSize) {
      if (pageSize === "all" || totalPages <= 1) {
        refs.paginationWrap.style.display = "none";
        return;
      }
      refs.paginationWrap.style.display = "flex";
      refs.paginationWrap.innerHTML = "";

      const prev = document.createElement("button");
      prev.className = "page-btn";
      prev.textContent = "Prev";
      prev.disabled = current <= 1;
      prev.addEventListener("click", () => {
        if (current > 1) {
          currentPage--;
          refreshPage();
        }
      });
      refs.paginationWrap.appendChild(prev);

      // Smart pagination: show all pages or use ellipses for large page counts.
      if (totalPages <= 10) {
        for (let i = 1; i <= totalPages; i++) {
          const b = document.createElement("button");
          b.className = "page-btn" + (i === current ? " active" : "");
          b.textContent = i;
          b.addEventListener("click", () => {
            currentPage = i;
            refreshPage();
          });
          refs.paginationWrap.appendChild(b);
        }
      } else {
        const first = document.createElement("button");
        first.className = "page-btn";
        first.textContent = "1";
        first.addEventListener("click", () => {
          currentPage = 1;
          refreshPage();
        });
        refs.paginationWrap.appendChild(first);

        if (current > 4) {
          const dots = document.createElement("span");
          dots.textContent = "...";
          refs.paginationWrap.appendChild(dots);
        }

        const start = Math.max(2, current - 2);
        const end = Math.min(totalPages - 1, current + 2);
        for (let i = start; i <= end; i++) {
          const b = document.createElement("button");
          b.className = "page-btn" + (i === current ? " active" : "");
          b.textContent = i;
          b.addEventListener("click", () => {
            currentPage = i;
            refreshPage();
          });
          refs.paginationWrap.appendChild(b);
        }

        if (current < totalPages - 3) {
          const dots2 = document.createElement("span");
          dots2.textContent = "...";
          refs.paginationWrap.appendChild(dots2);
        }

        const last = document.createElement("button");
        last.className = "page-btn";
        last.textContent = totalPages;
        last.addEventListener("click", () => {
          currentPage = totalPages;
          refreshPage();
        });
        refs.paginationWrap.appendChild(last);
      }
      const next = document.createElement("button");
      next.className = "page-btn";
      next.textContent = "Next";
      next.disabled = current >= totalPages;
      next.addEventListener("click", () => {
        if (current < totalPages) {
          currentPage++;
          refreshPage();
        }
      });
      refs.paginationWrap.appendChild(next);

      // "Go to page" input for quick navigation.
      const goWrap = document.createElement("div");
      goWrap.className = "go-page";
      const goLabel = document.createElement("span");
      goLabel.style.color = "var(--muted)";
      goLabel.textContent = "Go to";
      const goInput = document.createElement("input");
      goInput.type = "number";
      goInput.min = 1;
      goInput.max = totalPages;
      goInput.value = current;
      goInput.setAttribute("aria-label", "Page number to go to");
      const goBtn = document.createElement("button");
      goBtn.className = "page-btn";
      goBtn.textContent = "Go";
      goBtn.addEventListener("click", () => {
        let v = parseInt(goInput.value, 10);
        if (isNaN(v)) return;
        if (v < 1) v = 1;
        if (v > totalPages) v = totalPages;
        currentPage = v;
        refreshPage();
        goBtn.blur();
      });
      goInput.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter") goBtn.click();
      });
      goWrap.appendChild(goLabel);
      goWrap.appendChild(goInput);
      goWrap.appendChild(goBtn);
      refs.paginationWrap.appendChild(goWrap);

      const info = document.createElement("div");
      info.style.marginLeft = "8px";
      info.style.color = "var(--muted)";
      info.textContent = `Page ${current} of ${totalPages} • ${totalItems} items`;
      refs.paginationWrap.appendChild(info);
    }

    /* --- DATA FILTERING & SORTING --- */

    /**
     * Filters and sorts the products based on the current UI controls.
     */
    function applyFilters() {
      const q = refs.searchInput.value.toLowerCase().trim();
      const cat = refs.categorySelect.value;
      const price = refs.priceSelect.value;
      const sort = refs.sortSelect.value;

      filteredProducts = PRODUCTS.filter((p) => {
        const m1 = !cat || p.category === cat;
        const m2 =
          !price || (getPriceLabelText(p) || "").toLowerCase() === price;
        const m3 =
          !q ||
          (p.title + p.description + p.category + (p.seoUrl || ""))
            .toLowerCase()
            .includes(q);
        return m1 && m2 && m3;
      });

      if (sort === "az")
        filteredProducts.sort((a, b) => a.title.localeCompare(b.title));
      else if (sort === "za")
        filteredProducts.sort((a, b) => b.title.localeCompare(a.title));
      // 'new' is the default, no sort needed as data is pre-sorted.

      currentPage = 1;
      refreshPage();
    }
    /**
     * Refreshes the product grid with the current page and page size.
     */
    function refreshPage() {
      currentPageSize = refs.pageSizeSelect.value || "all";
      renderProductsPage(filteredProducts, currentPage, currentPageSize);
    }

    /* --- EVENT LISTENERS --- */
    refs.searchInput.addEventListener("input", applyFilters);
    refs.categorySelect.addEventListener("change", applyFilters);
    refs.priceSelect.addEventListener("change", applyFilters);
    refs.sortSelect.addEventListener("change", applyFilters);
    refs.pageSizeSelect.addEventListener("change", () => {
      currentPage = 1;
      refreshPage();
    });
    refs.resetBtn.addEventListener("click", () => {
      refs.searchInput.value = "";
      refs.categorySelect.value = "";
      refs.priceSelect.value = "";
      refs.sortSelect.value = "new";
      refs.pageSizeSelect.value = "all";
      currentPage = 1;
      applyFilters();
    });

    /**
     * Initiates a file download for a given product ID.
     * For "download" type, it creates a blob; for "external", it opens the URL.
     */
    function startDownloadById(id, triggerEl) {
      const p = PRODUCTS.find((x) => x.id === id);
      if (!p) return;
      // Visual feedback: change clicked button to "Downloaded" temporarily
      const btn = triggerEl || (document.querySelector(`.download-btn[data-id="${CSS.escape(id)}"]`));
      const revertBtn = () => {
        if (btn) {
          btn.textContent = p.type === "external" ? (p.buttonLabel || "Buy Now") : "Download";
          btn.disabled = false;
          btn.classList.remove("downloaded");
        }
      };
      if (p.productUrl) {
        const a = document.createElement("a");
        a.href = p.productUrl;
        a.download = p.fileName || "";
        a.click();
        if (btn) {
          btn.textContent = "Downloaded";
          btn.disabled = true;
          btn.classList.add("downloaded");
          setTimeout(revertBtn, 2500);
        }
        return;
      }
      const blob = createDemoFileBlob(p);
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = p.fileName || p.title + ".txt";
      a.click();
      if (btn) {
        btn.textContent = "Downloaded";
        btn.disabled = true;
        btn.classList.add("downloaded");
        setTimeout(revertBtn, 2500);
      }
      setTimeout(() => URL.revokeObjectURL(url), 4000);
    }

    /**
     * Flips a product card to show its back face, and flips back any other card.
     */
    function flipCard(cardEl) {
      if (!cardEl) return;
      // Close any other card that is already flipped.
      document.querySelectorAll(".card.is-flipped").forEach((c) => {
        if (c !== cardEl) c.classList.remove("is-flipped");
      });
      // Toggle the flip state of the target card.
      const willFlip = !cardEl.classList.contains("is-flipped");
      if (willFlip) cardEl.classList.add("is-flipped");
      else cardEl.classList.remove("is-flipped");
    }

    // Delegated event listener for the product grid to handle card interactions.
    refs.grid.addEventListener("click", (e) => {
      const dl = e.target.closest(".download-btn");
      const det = e.target.closest(".details-btn");
      const back = e.target.closest(".back-btn");

      if (dl && dl.dataset.id) {
        e.preventDefault();
        startDownloadById(dl.dataset.id, dl);
        return;
      }

      if (back) {
        const card = back.closest(".card");
        if (card) card.classList.remove("is-flipped");
        return;
      }

      if (det) {
        const card = det.closest(".card");
        if (card) flipCard(card);
        // Ensure height persists after flip; height is based on front but uniform across.
        requestAnimationFrame(adjustCardHeights);
        return;
      }
    });

    /* Go To Top Button */
    window.addEventListener("scroll", () => {
      if (window.scrollY > 300) refs.goTopBtn.classList.add("show");
      else refs.goTopBtn.classList.remove("show");
    });
    refs.goTopBtn.addEventListener("click", () =>
      window.scrollTo({ top: 0, behavior: "smooth" })
    );

    /* --- UTILITIES --- */

    /**
     * Generates a sitemap.xml string from the product data.
     */
    function buildSitemapXml() {
      const domain = window.location.origin;

      const urls = PRODUCTS.map((p) => {
        const loc = p.seoUrl || p.productUrl || `${domain}/product/${p.id}`;
        return `
      <url>
        <loc>${loc}</loc>
        <changefreq>weekly</changefreq>
        <priority>0.8</priority>
      </url>
    `;
      }).join("");

      return `<?xml version="1.0" encoding="UTF-8"?>
  <urlset xmlns="https://www.sitemaps.org/schemas/sitemap/0.9">
    <url>
      <loc>${domain}</loc>
      <changefreq>daily</changefreq>
      <priority>1.0</priority>
    </url>
    ${urls}
  </urlset>`;
    }

    /* Keyboard shortcut: CTRL + SHIFT + S to generate and show the sitemap. */
    document.addEventListener("keydown", (e) => {
      if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === "s") {
        const xml = buildSitemapXml();
        const blob = new Blob([xml], { type: "application/xml" });
        const url = URL.createObjectURL(blob);

        const win = window.open();
        win.document.write(`
      <pre>${xml.replace(/</g, "&lt;")}</pre>
      <a href="${url}" download="sitemap.xml">Download sitemap.xml</a>
      <p>Upload this file to your site root (/sitemap.xml)</p>
    `);
        win.document.close();

        setTimeout(() => URL.revokeObjectURL(url), 60000);
      }
    });

    /* --- INITIALIZATION --- */

    /**
     * IIFE to set up initial state: populates filters and ensures data integrity.
     */
    (function setupFilters() {
      /**
       * Ensures each product has a unique, SEO-friendly URL (`seoUrl`).
       * Auto-generates a slug from the title if `seoUrl` is missing.
       */
      function ensureSeoUrls() {
        function slugify(s) {
          return (s || "")
            .toString()
            .trim()
            .toLowerCase()
            .replace(/["'`]/g, "")
            .replace(/[^a-z0-9\s-]/g, "")
            .replace(/\s+/g, "-")
            .replace(/-+/g, "-")
            .replace(/^[-]+|[-]+$/g, "");
        }
        const seen = new Set();
        // Pre-seed with any existing seoUrls to avoid duplicates.
        PRODUCTS.forEach((p) => {
          if (p.seoUrl) seen.add(p.seoUrl);
        });
        PRODUCTS.forEach((p) => {
          if (!p.seoUrl || !String(p.seoUrl).trim()) {
            const base =
              "/product/" + (slugify(p.title || p.id) || "product-" + p.id);
            let candidate = base;
            let i = 1;
            // Append a number if the slug already exists.
            while (seen.has(candidate)) {
              candidate = base + "-" + i;
              i++;
            }
            p.seoUrl = candidate;
            seen.add(candidate);
          }
        });
      }
      ensureSeoUrls();
      const cats = [...new Set(PRODUCTS.map((p) => p.category))].sort();
      cats.forEach((c) => {
        const op = document.createElement("option");
        op.value = c;
        op.textContent = c;
        refs.categorySelect.appendChild(op);
      });

      const prices = [
        ...new Set(
          PRODUCTS.map((p) => (getPriceLabelText(p) || "unknown").toLowerCase())
        ),
      ]
        .filter((p) => p !== "unknown")
        .sort();
      prices.forEach((pv) => {
        const op = document.createElement("option");
        op.value = pv;
        op.textContent = cap(pv);
        refs.priceSelect.appendChild(op);
      });

      // Perform initial SEO and structured data injection on load.
      updateTitleAndMeta();
      injectStructuredData();
    })();

    /* INITIAL RENDER */
    applyFilters();
    // Expose a minimal API to the global scope for runtime theme changes.
    window.setTheme = setTheme;

    /**
     * Measures all visible cards' front faces and sets a uniform height
     * equal to the tallest front content. Back face will scroll within this height.
     */
    function adjustCardHeights() {
      const cards = Array.from(document.querySelectorAll(".card"));
      if (!cards.length) return;
      // Reset inline heights to re-measure accurately.
      cards.forEach((c) => {
        c.style.height = "";
        const inner = c.querySelector(".card-inner");
        if (inner) inner.style.height = "";
      });
      let max = 0;
      // Measure the front face in-place by disabling transform temporarily.
      cards.forEach((card) => {
        const inner = card.querySelector(".card-inner");
        const front = card.querySelector(".card-front");
        if (!inner || !front) return;
        const prevTransform = inner.style.transform;
        inner.style.transform = "none";
        // Ensure not flipped while measuring front
        const wasFlipped = card.classList.contains("is-flipped");
        if (wasFlipped) card.classList.remove("is-flipped");
        const h = front.scrollHeight;
        if (h > max) max = h;
        // Restore state
        if (wasFlipped) card.classList.add("is-flipped");
        inner.style.transform = prevTransform || "";
      });
      if (max <= 0) return;
      // Apply uniform height to all cards and their inner containers.
      cards.forEach((card) => {
        card.style.height = max + "px";
        const inner = card.querySelector(".card-inner");
        if (inner) inner.style.height = "100%";
      });
    }

    // Recalculate on resize and orientation changes.
    window.addEventListener("resize", () =>
      requestAnimationFrame(adjustCardHeights)
    );
    window.addEventListener("orientationchange", () =>
      requestAnimationFrame(adjustCardHeights)
    );
    // Recalculate when images inside thumbs load (affects front height)
    document.addEventListener(
      "load",
      (ev) => {
        const t = ev.target;
        if (t && t.tagName === "IMG" && t.closest(".thumb")) {
          requestAnimationFrame(adjustCardHeights);
        }
      },
      true
    );
  })();
</script>