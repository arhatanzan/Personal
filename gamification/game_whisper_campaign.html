<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>The Whisper Campaign: Hostile Takeover</title>
    <style>
      :root {
        --bg-color: #f8f6f2;
        --card-bg: #ffffff;
        --text-main: #0a2342; /* Navy */
        --text-light: #5a6673; /* Slate */
        --accent: #d4a017; /* Gold */
        --danger: #7a2e2e; /* Red */
        --success: #27ab83; /* Green */
        --border-color: rgba(10, 35, 66, 0.15);
        --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: var(--font-main);
        background-color: var(--bg-color);
        color: var(--text-main);
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        overflow-y: auto;
      }

      /* --- HEADER --- */
      header {
        width: 100%;
        max-width: 900px;
        padding: 0.8rem;
        text-align: center;
        flex-shrink: 0;
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .header-content {
        text-align: center;
        width: 100%;
      }
      h1 {
        margin: 0;
        font-size: 1.1rem;
        color: var(--text-main);
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .subtitle {
        font-size: 0.7rem;
        color: var(--danger);
        font-weight: bold;
      }

      /* --- STATS --- */
      .stats-bar {
        display: flex;
        justify-content: center;
        gap: 8px;
        width: 95%;
        max-width: 800px;
        margin: 8px 0;
        flex-shrink: 0;
      }
      .stat-box {
        background: var(--card-bg);
        padding: 5px 10px;
        border-radius: 6px;
        text-align: center;
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        flex: 1;
      }
      .stat-label {
        font-size: 0.55rem;
        text-transform: uppercase;
        color: var(--text-light);
        font-weight: bold;
      }
      .stat-val {
        font-size: 1rem;
        font-weight: 800;
        color: var(--text-main);
        margin-top: 2px;
      }
      .stat-val.accent {
        color: var(--accent);
      }

      /* --- MAIN LAYOUT --- */
      .game-container {
        /* Size to content to avoid stretching gaps on zoom changes */
        flex: 0 0 auto;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        width: 98%;
        max-width: 1000px;
        gap: 10px;
        padding-bottom: 5px;
        overflow: visible;
      }

      /* Canvas Area */
      .viz-wrapper {
        flex: 3;
        position: relative;
        background: #eef2f6;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        overflow: hidden;
        min-height: 300px;
      }
      canvas {
        display: block;
        width: 100%;
        height: 100%;
      }

      .viz-legend {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.9);
        padding: 6px;
        border-radius: 4px;
        font-size: 0.65rem;
        color: var(--text-light);
        border: 1px solid var(--border-color);
        pointer-events: none;
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-top: 2px;
      }
      .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
      }

      /* Controls Area */
      .controls-container {
        flex: 2;
        display: flex;
        flex-direction: column;
        gap: 8px;
        background: var(--card-bg);
        padding: 12px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        overflow-y: auto;
        max-height: 45vh;
      }

      .section-header {
        font-size: 0.75rem;
        font-weight: bold;
        text-transform: uppercase;
        color: var(--text-light);
        margin-bottom: 6px;
        border-bottom: 1px solid #eee;
        padding-bottom: 4px;
        display: flex;
        justify-content: space-between;
      }

      /* Narrative Cards */
      .narrative-list {
        display: grid;
        grid-template-columns: 1fr;
        gap: 6px;
      }
      .narrative-opt {
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.1s;
        text-align: left;
        background: #fafafa;
        position: relative;
      }
      .narrative-opt:hover {
        border-color: var(--accent);
        background: #fff;
      }
      .narrative-opt.selected {
        background: #fff9e6;
        border: 2px solid var(--accent);
      }

      .nar-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.8rem;
        font-weight: bold;
      }
      .nar-cost {
        background: var(--text-main);
        color: #fff;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.7rem;
      }
      .nar-desc {
        font-size: 0.75rem;
        color: var(--text-main);
        margin: 4px 0;
        line-height: 1.3;
      }
      .nar-tag {
        font-size: 0.65rem;
        padding: 2px 5px;
        border-radius: 3px;
        font-weight: bold;
        text-transform: uppercase;
      }
      .tag-rumor {
        color: #d64545;
        background: #ffe3e3;
      }
      .tag-policy {
        color: #334e68;
        background: #bcccdc;
      }
      .tag-culture {
        color: #d4a017;
        background: #fff4ce;
      }

      /* Target Select */
      .target-select {
        width: 100%;
        padding: 10px;
        border-radius: 4px;
        border: 1px solid var(--border-color);
        background: #fff;
        color: var(--text-main);
        font-size: 0.9rem;
        font-weight: bold;
      }

      .btn-plant {
        width: 100%;
        padding: 12px;
        background: var(--accent);
        color: var(--text-main);
        border: none;
        border-radius: 6px;
        font-weight: 800;
        font-size: 0.9rem;
        text-transform: uppercase;
        cursor: pointer;
        margin-top: auto;
        box-shadow: 0 2px 0 #b38612;
      }
      .btn-plant:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        box-shadow: none;
        background: #ddd;
      }

      /* Desktop Layout */
      @media (min-width: 768px) {
        .game-container {
          flex-direction: row;
          height: 80vh;
        }
        .viz-wrapper {
          flex: 2;
          height: 100%;
        }
        .controls-container {
          flex: 1;
          max-height: none;
        }
      }

      .copyright {
        font-size: 0.7rem;
        color: var(--text-light);
        opacity: 0.6;
        text-align: center;
        padding: 4px 0 8px 0;
        flex-shrink: 0;
      }

      /* --- MODALS --- */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(10, 35, 66, 0.95);
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        color: white;
        text-align: center;
        padding: 20px;
      }
      .modal.active {
        display: flex;
      }
      .modal-content {
        background: white;
        color: var(--text-main);
        padding: 25px;
        border-radius: 10px;
        max-width: 500px;
        width: 100%;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        border-top: 5px solid var(--danger);
      }
      .modal h2 {
        color: var(--danger);
        margin-top: 0;
        text-transform: uppercase;
      }
      .modal p {
        font-size: 0.95rem;
        line-height: 1.5;
        color: var(--text-light);
        margin-bottom: 20px;
        text-align: left;
      }
      .btn-modal {
        background: var(--text-main);
        color: var(--accent);
        padding: 12px 20px;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        width: 100%;
        text-transform: uppercase;
      }

      .tutorial-step {
        margin-bottom: 12px;
        border-left: 3px solid var(--danger);
        padding-left: 10px;
        text-align: left;
        font-size: 0.9rem;
      }
      .tutorial-step strong {
        display: block;
        color: var(--text-main);
      }
      /* Small-screen responsive fixes: reduce vertical gaps and stack stat boxes */
      @media (max-width: 600px) {
        .stats-bar, .dashboard {
          grid-template-columns: 1fr;
          gap: 8px;
          width: 95%;
          margin: 0.5rem 0;
        }
        /* Avoid large vertical centering on tall small-viewports */
        .game-container, .game-layout, .viz-wrapper {
          max-width: 100%;
          padding-bottom: 1rem;
          justify-content: flex-start !important;
          padding-top: 0.25rem;
          flex: 0 0 auto;
          min-height: 0;
        }
        .card-stack { height: auto !important; margin-bottom: 8px; }
        .card { position: relative !important; height: auto !important; top: auto !important; left: auto !important; padding: 1.25rem; }
        body { min-height: auto !important; height: auto !important; }
        .controls, .broadcast-slots { gap: 8px; padding: 8px; justify-content: center; }
        .btn, .btn-modal { padding: 0.6rem; font-size: 0.95rem; }
        .viz-legend { display: none; }
        header { padding: 0.6rem; }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-content">
        <h1>The Whisper Campaign</h1>
        <div class="subtitle">Scenario: Total Opposition</div>
      </div>
    </header>

    <div class="stats-bar">
      <div class="stat-box">
        <span class="stat-label">Total Loyalty</span>
        <div class="stat-val" id="val-opinion">15%</div>
      </div>
      <div class="stat-box">
        <span class="stat-label">Influence</span>
        <div class="stat-val accent" id="val-influence">180</div>
      </div>
      <div class="stat-box">
        <span class="stat-label">Days Left</span>
        <div class="stat-val" id="val-days">14</div>
      </div>
    </div>

    <main class="game-container">
      <div class="viz-wrapper" id="viz-wrapper">
        <canvas id="networkCanvas"></canvas>

        <div class="viz-legend">
          <div class="legend-item">
            <div class="dot" style="background: var(--danger)"></div>
            Hostile
          </div>
          <div class="legend-item">
            <div class="dot" style="background: var(--text-light)"></div>
            Neutral
          </div>
          <div class="legend-item">
            <div class="dot" style="background: var(--text-main)"></div>
            Loyal
          </div>
          <div class="legend-item">
            <div
              style="width: 15px; height: 2px; background: var(--accent)"
            ></div>
            Active Spread
          </div>
        </div>
      </div>

      <div class="controls-container">
        <div>
          <div class="section-header">
            <span>1. Today's Headlines</span>
            <span style="font-size: 0.6rem; opacity: 0.7">Cycles Daily</span>
          </div>
          <div class="narrative-list" id="narrative-list"></div>
        </div>

        <div>
          <div class="section-header">2. Injection Point</div>
          <select class="target-select" id="target-select"></select>
        </div>

        <button class="btn-plant" id="btn-plant" disabled>
          Launch Campaign
        </button>
      </div>
    </main>

    <div class="copyright">Â© 2025 Kaif Abbas</div>

    <div class="modal active" id="start-modal">
      <div class="modal-content">
        <h2>Situation Critical</h2>
        <p>
          You are the opposition strategist. The incumbent has
          <strong>total control</strong>. Every district starts hostile (Red).
          Your goal: Hijack the election.
        </p>

        <div class="tutorial-step">
          <strong>1. Everyone Hates You</strong>
          Starting Support is ~15%. "Truths" will fail. You must use cheap
          "Rumors" or "Scandals" to break the initial wall.
        </div>
        <div class="tutorial-step">
          <strong>2. Establish a Beachhead</strong>
          Target low-resistance groups first (Students or Slums). Do not attack
          the Country Club yet.
        </div>
        <div class="tutorial-step">
          <strong>3. The Dictator Strategy</strong>
          Once you flip a node, their neighbors will soften due to "Peer
          Pressure." Convert the poor to pressure the rich.
        </div>

        <button class="btn-modal" onclick="startGame()">
          Start Insurgency
        </button>
      </div>
    </div>

    <div class="modal" id="end-modal">
      <div class="modal-content">
        <h2 id="end-title">Campaign Over</h2>
        <p id="end-desc">...</p>
        <button class="btn-modal" onclick="location.reload()">
          New Election
        </button>
      </div>
    </div>

    <script>
      // --- GAME CONFIG ---
      const TARGET_SCORE = 60; // 60% is a landslide in a hostile district
      const INITIAL_DAYS = 14; // Increased time
      const INITIAL_INF = 180; // Increased budget

      // --- INDIAN CONTEXT NARRATIVES (POOL) ---
      const NARRATIVE_POOL = [
        {
          title: "Free Electricity Promise",
          type: "Freebie",
          cost: 40,
          power: 25,
          vir: 0.9,
          desc: "Promise 200 units free power.",
          hint: "High impact on poor/middle class.",
        },
        {
          title: "Temple/Mosque Renovation Fund",
          type: "Culture",
          cost: 30,
          power: 15,
          vir: 0.7,
          desc: "Donation drive for local temple/mosque.",
          hint: "Flips Traditionalists.",
        },
        {
          title: "Metro Extension Plan",
          type: "Policy",
          cost: 25,
          power: 10,
          vir: 0.4,
          desc: "Map of new metro lines.",
          hint: "Good for RWA/Students.",
        },
        {
          title: "Scandal: Non-Veg Tuesday",
          type: "Scandal",
          cost: 20,
          power: 12,
          vir: 0.8,
          desc: "Opponent ate chicken on holy day.",
          hint: "Cheap, high viral spread.",
        },
        {
          title: "Deepfake: Corruption Audio",
          type: "Scandal",
          cost: 60,
          power: 40,
          vir: 0.95,
          desc: "AI audio of opponent taking bribes.",
          hint: "Expensive but devastating.",
        },
        {
          title: "Cricket Match Screening",
          type: "Culture",
          cost: 15,
          power: 5,
          vir: 0.5,
          desc: "Free screening of India vs Pak.",
          hint: "Low impact, creates goodwill.",
        },
        {
          title: "Army Border Standoff",
          type: "Culture",
          cost: 35,
          power: 20,
          vir: 0.8,
          desc: "Rally to support our troops.",
          hint: "Universal appeal.",
        },
        {
          title: "Water Tanker Scam",
          type: "Scandal",
          cost: 30,
          power: 18,
          vir: 0.7,
          desc: "Expose water mafia links.",
          hint: "Effective in Slums/RWA.",
        },
        {
          title: "Scholarship Scheme",
          type: "Policy",
          cost: 20,
          power: 15,
          vir: 0.3,
          desc: "Tablets for toppers.",
          hint: "Students love this.",
        },
        {
          title: "Foreign Conspiracy",
          type: "Rumor",
          cost: 25,
          power: 10,
          vir: 0.9,
          desc: "Opponent funded by enemies.",
          hint: "WhatsApp favorites.",
        },
        {
          title: "Road Repair Blitz",
          type: "Policy",
          cost: 35,
          power: 15,
          vir: 0.5,
          desc: "Fix potholes overnight.",
          hint: "Auto Unions/RWA.",
        },
        {
          title: "Festival Bonus",
          type: "Freebie",
          cost: 50,
          power: 30,
          vir: 0.8,
          desc: "Cash transfer before Diwali.",
          hint: "Massive sway.",
        },
      ];

      // --- NODES (ALL HOSTILE START) ---
      // opinion: Starts very low (10-25)
      // resist: 0.1 (Gullible) to 0.9 (Stubborn)
      let NODES = [
        {
          id: "rwa",
          label: "RWA Uncles",
          x: 0.2,
          y: 0.2,
          opinion: 15,
          resist: 0.6,
        },
        {
          id: "kitty",
          label: "Kitty Party",
          x: 0.8,
          y: 0.2,
          opinion: 20,
          resist: 0.4,
        },
        {
          id: "students",
          label: "Student Union",
          x: 0.2,
          y: 0.8,
          opinion: 25,
          resist: 0.15,
        }, // Beachhead opportunity
        {
          id: "traders",
          label: "Traders Assoc",
          x: 0.8,
          y: 0.8,
          opinion: 10,
          resist: 0.7,
        },
        {
          id: "slum",
          label: "Slum Leaders",
          x: 0.5,
          y: 0.9,
          opinion: 20,
          resist: 0.1,
        }, // Beachhead opportunity
        {
          id: "auto",
          label: "Auto Union",
          x: 0.5,
          y: 0.5,
          opinion: 15,
          resist: 0.3,
        },
        {
          id: "whatsapp",
          label: "WhatsApp Grp",
          x: 0.5,
          y: 0.2,
          opinion: 15,
          resist: 0.1,
        },
      ];

      // --- EDGES ---
      const LINKS = [
        { src: "rwa", tgt: "whatsapp" },
        { src: "kitty", tgt: "whatsapp" },
        { src: "rwa", tgt: "traders" },
        { src: "traders", tgt: "auto" },
        { src: "students", tgt: "auto" },
        { src: "slum", tgt: "auto" },
        { src: "students", tgt: "whatsapp" },
        { src: "kitty", tgt: "traders" },
      ];

      // --- STATE ---
      let state = {
        days: INITIAL_DAYS,
        influence: INITIAL_INF,
        dailyOptions: [],
        selectedNar: null,
        activeSpreading: false,
      };

      // --- CANVAS ENGINE ---
      const canvas = document.getElementById("networkCanvas");
      const ctx = canvas.getContext("2d");

      function startGame() {
        document.getElementById("start-modal").classList.remove("active");
        rollDailyNarratives();
        renderTargets();
        updateStats();
        resize();
        draw();
      }

      function resize() {
        const wrap = document.getElementById("viz-wrapper");
        const dpr = window.devicePixelRatio || 1;
        canvas.width = wrap.clientWidth * dpr;
        canvas.height = wrap.clientHeight * dpr;
        ctx.scale(dpr, dpr);
        draw();
      }
      window.addEventListener("resize", resize);

      function draw() {
        const w = canvas.width / (window.devicePixelRatio || 1);
        const h = canvas.height / (window.devicePixelRatio || 1);
        ctx.clearRect(0, 0, w, h);

        // Draw Links
        ctx.lineWidth = 2;
        LINKS.forEach((l) => {
          const s = NODES.find((n) => n.id === l.src);
          const t = NODES.find((n) => n.id === l.tgt);

          ctx.beginPath();
          ctx.moveTo(s.x * w, s.y * h);
          ctx.lineTo(t.x * w, t.y * h);

          if (s.infected && t.infected) {
            ctx.strokeStyle = "#d4a017"; // Active Flow
            ctx.setLineDash([5, 5]);
          } else {
            ctx.strokeStyle = "#d1d5db";
            ctx.setLineDash([]);
          }
          ctx.stroke();
        });

        // Draw Nodes
        NODES.forEach((n) => {
          const nx = n.x * w;
          const ny = n.y * h;
          const r = w < 400 ? 35 : 45;

          // Fill Color
          ctx.beginPath();
          ctx.arc(nx, ny, r, 0, Math.PI * 2);
          ctx.fillStyle = getOpinionColor(n.opinion);
          ctx.fill();

          // Border
          ctx.lineWidth = n.infected ? 4 : 2;
          ctx.strokeStyle = n.infected ? "#d4a017" : "#fff";
          ctx.stroke();

          // Text
          ctx.fillStyle = "#fff";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          const fontSize = w < 400 ? 10 : 11;
          ctx.font = `bold ${fontSize}px sans-serif`;

          drawText(ctx, n.label, nx, ny, r * 1.8, fontSize * 1.1);

          // Value
          ctx.fillStyle = "#0a2342";
          ctx.font = `bold ${fontSize}px sans-serif`;
          ctx.fillText(`${Math.round(n.opinion)}%`, nx, ny + r + 14);
        });
      }

      function drawText(ctx, text, x, y, maxWidth, lineHeight) {
        const words = text.split(" ");
        let lines = [];
        let currentLine = words[0];

        for (let i = 1; i < words.length; i++) {
          let word = words[i];
          let width = ctx.measureText(currentLine + " " + word).width;
          if (width < maxWidth) {
            currentLine += " " + word;
          } else {
            lines.push(currentLine);
            currentLine = word;
          }
        }
        lines.push(currentLine);

        let startY = y - ((lines.length - 1) * lineHeight) / 2;
        lines.forEach((line, i) => {
          ctx.fillText(line, x, startY + i * lineHeight);
        });
      }

      function getOpinionColor(val) {
        if (val < 40) return "#7a2e2e"; // Hostile
        if (val > 60) return "#0a2342"; // Loyal
        return "#5a6673"; // Neutral
      }

      // --- LOGIC ---

      function rollDailyNarratives() {
        state.dailyOptions = [];
        let pool = [...NARRATIVE_POOL];
        for (let i = 0; i < 3; i++) {
          const idx = Math.floor(Math.random() * pool.length);
          state.dailyOptions.push(pool[idx]);
          pool.splice(idx, 1);
        }
        renderNarratives();
      }

      function selectNarrative(idx) {
        if (state.activeSpreading) return;
        state.selectedNar = state.dailyOptions[idx];

        document
          .querySelectorAll(".narrative-opt")
          .forEach((el) => el.classList.remove("selected"));
        document.getElementById(`nar-card-${idx}`).classList.add("selected");

        checkButton();
      }

      function checkButton() {
        const btn = document.getElementById("btn-plant");
        if (state.selectedNar && state.influence >= state.selectedNar.cost) {
          btn.disabled = false;
          btn.innerText = `Plant Info (-${state.selectedNar.cost} Inf)`;
        } else {
          btn.disabled = true;
          btn.innerText = state.selectedNar
            ? "Not Enough Influence"
            : "Select Narrative";
        }
      }

      document.getElementById("btn-plant").addEventListener("click", () => {
        const targetId = document.getElementById("target-select").value;
        const target = NODES.find((n) => n.id === targetId);

        state.influence -= state.selectedNar.cost;
        state.days--;

        target.infected = true;
        target.virus = state.selectedNar;

        startSimulation();
      });

      function startSimulation() {
        state.activeSpreading = true;
        document.getElementById("btn-plant").disabled = true;

        let ticks = 0;
        const maxTicks = 6;

        const interval = setInterval(() => {
          ticks++;

          NODES.forEach((n) => {
            let neighbors = [];
            LINKS.forEach((l) => {
              if (l.src === n.id)
                neighbors.push(NODES.find((x) => x.id === l.tgt));
              if (l.tgt === n.id)
                neighbors.push(NODES.find((x) => x.id === l.src));
            });

            let neighborSupport =
              neighbors.reduce((sum, nb) => sum + nb.opinion, 0) /
              (neighbors.length || 1);

            // --- HOSTILE DYNAMICS ---
            // If neighbors are hostile, resistance INCREASES.
            // If neighbors are loyal, resistance DECREASES (Peer Pressure).
            let dynamicResist = n.resist;
            if (neighborSupport > 55) dynamicResist -= 0.15;
            if (neighborSupport < 30) dynamicResist += 0.1;

            if (n.infected) {
              const boost = n.virus.power * (1 - Math.max(0, dynamicResist));
              n.opinion = Math.min(100, n.opinion + boost / 3);

              neighbors.forEach((nb) => {
                if (!nb.infected) {
                  let chance =
                    n.virus.vir - nb.resist + (neighborSupport > 50 ? 0.2 : 0);
                  if (Math.random() < chance) {
                    nb.infected = true;
                    nb.virus = n.virus;
                  }
                }
              });
            }
          });

          draw();
          updateStats();

          if (ticks >= maxTicks) {
            clearInterval(interval);
            endTurn();
          }
        }, 400);
      }

      function endTurn() {
        state.activeSpreading = false;
        NODES.forEach((n) => {
          n.infected = false;
          n.virus = null;
        });
        draw();

        checkWinLoss();
        rollDailyNarratives();
        state.selectedNar = null;
        checkButton();
      }

      function getAvgOpinion() {
        return Math.round(
          NODES.reduce((a, b) => a + b.opinion, 0) / NODES.length
        );
      }

      function updateStats() {
        const avg = getAvgOpinion();
        document.getElementById("val-opinion").innerText = `${avg}%`;
        document.getElementById("val-influence").innerText = state.influence;
        document.getElementById("val-days").innerText = state.days;

        const opEl = document.getElementById("val-opinion");
        if (avg >= TARGET_SCORE) opEl.style.color = "var(--success)";
        else if (avg < 40) opEl.style.color = "var(--danger)";
        else opEl.style.color = "var(--text-main)";
      }

      function checkWinLoss() {
        const avg = getAvgOpinion();
        if (state.days <= 0 || state.influence < 15) {
          let title = "Election Result";
          let msg = "";
          let color = "";

          if (avg >= 85) {
            title = "DICTATORSHIP";
            msg = "Total Control. Opposition eliminated.";
            color = "var(--accent)";
          } else if (avg >= 60) {
            title = "VICTORY";
            msg = "You hijacked the election against all odds.";
            color = "var(--success)";
          } else {
            title = "DEFEAT";
            msg = "The incumbent crushed your rebellion.";
            color = "var(--danger)";
          }

          const m = document.getElementById("end-modal");
          const t = document.getElementById("end-title");
          t.innerText = title;
          t.style.color = color;
          document.getElementById(
            "end-desc"
          ).innerText = `${msg} Final Support: ${avg}%`;
          m.classList.add("active");
        }
      }

      // --- RENDERING ---
      function renderNarratives() {
        const list = document.getElementById("narrative-list");
        list.innerHTML = "";
        state.dailyOptions.forEach((n, idx) => {
          const el = document.createElement("div");
          el.className = "narrative-opt";
          el.id = `nar-card-${idx}`;

          let tagClass =
            n.type === "Rumor" || n.type === "Scandal"
              ? "tag-rumor"
              : n.type === "Policy"
              ? "tag-policy"
              : "tag-culture";

          el.innerHTML = `
                <div class="nar-top">
                    <span>${n.title}</span>
                    <span class="nar-cost">${n.cost} Inf</span>
                </div>
                <div class="nar-desc">${n.desc}</div>
                <span class="nar-tag ${tagClass}">${n.type}</span>
                <span style="font-size:0.65rem; color:var(--text-light)">${n.hint}</span>
            `;
          el.onclick = () => selectNarrative(idx);
          list.appendChild(el);
        });
      }

      function renderTargets() {
        const sel = document.getElementById("target-select");
        sel.innerHTML = "";
        NODES.forEach((n) => {
          const opt = document.createElement("option");
          opt.value = n.id;
          opt.innerText = `${n.label} (Current: ${Math.round(n.opinion)}%)`;
          sel.appendChild(opt);
        });
      }
    </script>
  </body>
</html>
